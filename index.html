<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>◊ò◊ï◊§◊° ◊®◊ô◊©◊ï◊ù ◊ú◊§◊¢◊ô◊ú◊ï◊ô◊ï◊™ ◊ó◊ô◊†◊ï◊õ◊ô◊ï◊™</title>
    <!-- Optimized Hebrew fonts with better rendering -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;500;600;700;800&family=Rubik:wght@300;400;500;600;700;800&family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* Modern CSS Variables */
        :root {
            --primary-color: #1a73e8;
            --primary-hover: #1557b0;
            --secondary-color: #34a853;
            --accent-color: #fbbc04;
            --error-color: #ea4335;
            --warning-color: #ff9800;
            --success-color: #34a853;
            
            /* Navigation colors */
            --nav-bg: linear-gradient(135deg, #1a73e8, #34a853);
            --nav-active: rgba(255, 255, 255, 0.2);
            --nav-hover: rgba(255, 255, 255, 0.1);
            
            /* Modern dropdown colors */
            --dropdown-bg: #ffffff;
            --dropdown-border: #e2e8f0;
            --dropdown-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            --dropdown-item-hover: #f8fafc;
            --dropdown-item-selected: #e3f2fd;
            --dropdown-item-active: var(--primary-color);
            --dropdown-scroll-thumb: #cbd5e0;
            --dropdown-scroll-track: #f7fafc;
            
            /* Professional Hebrew typography stack */
            --hebrew-font: 'Assistant', 'Rubik', 'Segoe UI', 'Tahoma', 'Arial Hebrew', system-ui, sans-serif;
            --hebrew-font-bold: 'Assistant', 'Rubik', 'Segoe UI', 'Tahoma', 'Arial Hebrew', system-ui, sans-serif;
            --latin-font: 'Inter', 'Segoe UI', 'Roboto', 'Helvetica Neue', system-ui, sans-serif;
            
            /* Typography color system */
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
            --text-muted: #718096;
            --text-inverse: #ffffff;
            
            /* Surface colors for better contrast */
            --surface-color: #ffffff;
            --surface-secondary: #f7fafc;
            --surface-elevated: #ffffff;
            --border-color: #e2e8f0;
            --hover-color: rgba(66, 153, 225, 0.05);
            --light-bg: #f8fafc;
            
            /* Spacing */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            
            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
            --shadow-md: 0 3px 6px rgba(0, 0, 0, 0.16), 0 3px 6px rgba(0, 0, 0, 0.23);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.19), 0 6px 6px rgba(0, 0, 0, 0.23);
            
            /* Border radius */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* Enhanced Hebrew Typography with better rendering */
        body {
            font-family: var(--hebrew-font);
            line-height: 1.6;
            color: var(--text-primary);
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            font-size: 16px;
            min-height: 100vh;
            padding: 0;
            margin: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            font-feature-settings: 'kern' 1, 'liga' 1;
        }

        /* Modern full-width container with card design */
        .container {
            width: 100%;
            max-width: 100%;
            margin: 0;
            background: white;
            padding: var(--spacing-xl);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            transition: box-shadow 0.3s ease, transform 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color), var(--accent-color));
        }

        .container:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        /* Modern headers */
        h1, h2, h3 {
            font-family: var(--hebrew-font-bold);
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        h1 {
            font-size: clamp(24px, 4vw, 32px);
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: var(--spacing-xl);
            text-align: center;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
        }

        h1::before {
            content: 'üëë';
            font-size: 0.8em;
            -webkit-text-fill-color: initial;
            background: none;
        }

        h1::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            border-radius: var(--radius-sm);
        }

        h2 {
            font-size: 24px;
            color: var(--primary-color);
            margin-bottom: var(--spacing-lg);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        h2::before {
            content: 'üíé';
            font-size: 0.8em;
        }

        /* Enhanced form styling */
        .form-group {
            margin-bottom: var(--spacing-lg);
            position: relative;
        }

        /* Modern floating label design */
        .form-field {
            position: relative;
            margin-bottom: var(--spacing-lg);
        }
        
        /* Modern Searchable Dropdown Styles */
        .modern-dropdown {
            position: relative;
            width: 100%;
        }
        
        .dropdown-input {
            width: 100%;
            padding: 16px 48px 16px 12px;
            border: 2px solid #e5e7eb;
            border-radius: var(--radius-md);
            font-size: 16px;
            font-family: var(--hebrew-font);
            background: #fefefe;
            direction: rtl;
            text-align: right;
            color: var(--text-primary);
            font-weight: 500;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            z-index: 1;
        }
        
        .dropdown-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
            background: white;
        }
        
        .dropdown-input::placeholder {
            color: #9ca3af;
            direction: rtl;
            text-align: right;
        }
        
        .dropdown-arrow {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            transition: transform 0.2s ease;
            color: var(--text-secondary);
            font-size: 18px;
            z-index: 2;
        }
        
        .modern-dropdown.open .dropdown-arrow {
            transform: translateY(-50%) rotate(180deg);
            color: var(--primary-color);
        }
        
        .dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--dropdown-bg);
            border: 2px solid var(--dropdown-border);
            border-top: none;
            border-radius: 0 0 var(--radius-md) var(--radius-md);
            box-shadow: var(--dropdown-shadow);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            scrollbar-width: thin;
            scrollbar-color: var(--dropdown-scroll-thumb) var(--dropdown-scroll-track);
        }
        
        .dropdown-list::-webkit-scrollbar {
            width: 8px;
        }
        
        .dropdown-list::-webkit-scrollbar-track {
            background: var(--dropdown-scroll-track);
        }
        
        .dropdown-list::-webkit-scrollbar-thumb {
            background: var(--dropdown-scroll-thumb);
            border-radius: 4px;
        }
        
        .dropdown-list::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }
        
        .modern-dropdown.open .dropdown-list {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.15s ease;
            border-bottom: 1px solid rgba(226, 232, 240, 0.5);
            display: flex;
            align-items: center;
            justify-content: space-between;
            direction: rtl;
            text-align: right;
            font-family: var(--hebrew-font);
            font-size: 15px;
            color: var(--text-primary);
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .dropdown-item:hover {
            background: var(--dropdown-item-hover);
            transform: translateX(2px);
        }
        
        .dropdown-item.highlighted {
            background: var(--dropdown-item-selected);
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .dropdown-item.selected {
            background: var(--dropdown-item-active);
            color: white;
            font-weight: 600;
        }
        
        .dropdown-item .item-text {
            flex: 1;
        }
        
        .dropdown-item .item-badge {
            background: rgba(26, 115, 232, 0.1);
            color: var(--primary-color);
            padding: 2px 8px;
            border-radius: 12px;
        }
        
        .dropdown-item .item-badges {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        
        .dropdown-item .admin-count {
            background: rgba(34, 197, 94, 0.1);
            color: #059669;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .dropdown-empty {
            padding: 16px;
            text-align: center;
            color: var(--text-secondary);
            font-style: italic;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .dropdown-loading {
            padding: 16px;
            text-align: center;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .dropdown-loading .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #e5e7eb;
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Search highlight */
        .dropdown-item .highlight {
            background: rgba(255, 235, 59, 0.3);
            font-weight: 700;
            padding: 0 2px;
            border-radius: 2px;
        }
        
        /* Recent selections section */
        .dropdown-section {
            padding: 8px 16px 4px;
            background: #f8fafc;
            border-bottom: 1px solid var(--dropdown-border);
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .dropdown-input {
                padding: 14px 40px 14px 12px;
                font-size: 16px; /* Prevent zoom on iOS */
            }
            
            .dropdown-list {
                max-height: 250px;
            }
            
            .dropdown-item {
                padding: 14px 16px;
                font-size: 16px;
            }
            
            .dropdown-arrow {
                font-size: 16px;
            }
        }
        
        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            .dropdown-item:hover {
                transform: none;
            }
            
            .dropdown-item:active {
                background: var(--dropdown-item-selected);
                transform: scale(0.98);
            }
        }

        label {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-sm);
            font-weight: 600;
            color: var(--text-primary);
            font-size: 15px;
            transition: all 0.2s ease;
            letter-spacing: -0.01em;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        label::before {
            font-size: 1em;
        }

        label[for="parentName"]::before { content: 'üë§'; }
        label[for="phoneNumber"]::before { content: 'üìû'; }
        label[for="email"]::before { content: 'üìß'; }
        label[for="childName"]::before { content: 'üë∂'; }
        label[for="childBirthDate"]::before { content: 'üéÇ'; }
        label[for="cycleSearch"]::before { content: 'üîç'; }
        label[for="programCycle"]::before { content: 'üéØ'; }
        label[for="adminCycleSelect"]::before { content: '‚öôÔ∏è'; }

        input, select {
            width: 100%;
            padding: 16px 12px;
            border: 2px solid #e5e7eb;
            border-radius: var(--radius-md);
            font-size: 16px;
            font-family: var(--hebrew-font);
            transition: all 0.3s ease;
            background: #fefefe;
            direction: rtl;
            text-align: right;
            color: var(--text-primary);
            font-weight: 500;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            letter-spacing: -0.01em;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
            background: white;
        }

        input::placeholder {
            color: #9ca3af;
            direction: rtl;
            text-align: right;
        }

        /* Enhanced button design */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            padding: 14px 28px;
            border: none;
            border-radius: var(--radius-md);
            font-family: var(--hebrew-font);
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .submit-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
            color: white;
            width: 100%;
            padding: 16px 32px;
            font-size: 18px;
            box-shadow: var(--shadow-sm);
            position: relative;
        }

        .submit-btn::before {
            content: '‚≠ê';
            margin-left: var(--spacing-xs);
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .submit-btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .payment-btn {
            background: linear-gradient(135deg, var(--accent-color), #f59e0b);
            color: #1f2937;
            font-weight: 700;
            padding: 16px 32px;
            font-size: 18px;
            box-shadow: var(--shadow-md);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
        }

        .payment-btn::before {
            content: 'üíé';
            font-size: 1.2em;
        }

        .payment-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            text-decoration: none;
            color: #1f2937;
        }

        .payment-btn:visited {
            color: #1f2937;
        }

        /* Loading states */
        .loading {
            text-align: center;
            color: #6b7280;
            font-style: italic;
            padding: var(--spacing-lg);
        }

        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: var(--radius-sm);
            height: 20px;
            margin: var(--spacing-sm) 0;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Enhanced error styling */
        .error {
            color: var(--error-color);
            font-size: 14px;
            margin-top: var(--spacing-sm);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .error::before {
            content: '‚ö†Ô∏è';
            font-size: 12px;
        }

        /* Admin section improvements */
        #adminSection {
            margin-top: 0;
        }

        .admin-header {
            background: linear-gradient(135deg, var(--secondary-color), #2e7d32);
            color: white;
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            margin: -var(--spacing-xl) -var(--spacing-xl) var(--spacing-lg) -var(--spacing-xl);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .admin-header::before {
            content: 'üë®‚Äçüíº';
            font-size: 1.5em;
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            min-width: 300px;
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            color: white;
            font-weight: 600;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background: var(--success-color);
        }

        .toast.error {
            background: var(--error-color);
        }

        .toast.info {
            background: var(--primary-color);
        }

        /* Enhanced modal styling with better typography */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--surface-elevated);
            padding: var(--spacing-xl);
            border-radius: var(--radius-lg);
            max-width: 600px;
            width: 90%;
            box-shadow: var(--shadow-lg);
            transform: scale(0.9);
            transition: transform 0.3s ease;
            font-family: var(--hebrew-font);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .modal-content h3 {
            color: var(--text-primary);
            font-weight: 700;
            font-size: 20px;
            margin-bottom: var(--spacing-md);
        }

        .modal-content h4 {
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 16px;
            margin: 0;
        }

        .modal-content p {
            color: var(--text-primary);
            font-size: 15px;
            font-weight: 500;
            line-height: 1.6;
        }

        .modal-content strong {
            color: var(--text-secondary);
            font-weight: 600;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-md);
            border-bottom: 2px solid #f3f4f6;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
            transition: color 0.2s ease;
        }

        .modal-close:hover {
            color: var(--error-color);
        }

        /* Enhanced full-width layout adjustments */
        .main-content {
            width: 100%;
            max-width: 100%;
            margin: 0;
            padding: var(--spacing-lg);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xl);
        }

        /* Page sections optimized for full width */
        .page-section {
            width: 100%;
            max-width: none;
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            padding: var(--spacing-xl);
            margin: 0;
            position: relative;
            overflow: hidden;
        }
        
        /* Form container improvements for better space usage */
        .form-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--spacing-lg);
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }
        
        @media (min-width: 768px) {
            .form-container {
                grid-template-columns: 1fr 1fr;
                gap: var(--spacing-xl);
            }
            
            /* Full width for certain fields */
            .form-group.full-width {
                grid-column: 1 / -1;
            }
            
            .main-content {
                padding: var(--spacing-xl);
            }
        }
        
        @media (min-width: 1024px) {
            .main-content {
                padding: var(--spacing-xl) var(--spacing-xl) * 2;
            }
            
            .page-section {
                padding: var(--spacing-xl) * 1.5;
            }
        }
        
        @media (min-width: 1440px) {
            .main-content {
                padding: var(--spacing-xl) * 2;
            }
            
            .form-container {
                max-width: 1000px;
                grid-template-columns: 1fr 1fr 1fr;
            }
            
            /* Specific grid spans for larger screens */
            .form-group.span-2 {
                grid-column: span 2;
            }
        }

        /* Premium header styling */
        .page-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: var(--spacing-xl) 0;
            text-align: center;
            margin-bottom: 0;
            box-shadow: var(--shadow-lg);
        }

        .page-header h1 {
            color: white;
            -webkit-text-fill-color: white;
            background: none;
            margin-bottom: 0;
        }

        .page-header h1::before {
            color: #ffd700;
        }

        /* Premium section styling */
        .premium-section {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            padding: var(--spacing-xl);
            position: relative;
            overflow: hidden;
            border-top: 4px solid transparent;
            border-image: linear-gradient(90deg, var(--primary-color), var(--secondary-color), var(--accent-color)) 1;
        }

        .premium-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color), var(--accent-color));
        }

        /* Responsive improvements */
        @media (max-width: 768px) {
            .main-content {
                padding: var(--spacing-md);
                grid-template-columns: 1fr;
            }

            .container {
                padding: var(--spacing-lg);
                margin: 0;
            }

            h1 {
                font-size: 24px;
            }

            .btn {
                padding: 12px 24px;
                font-size: 16px;
            }

            .modal-content {
                padding: var(--spacing-lg);
                width: 95%;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: var(--spacing-md);
            }

            .btn {
                padding: 10px 20px;
                font-size: 14px;
            }
        }

        /* Professional Admin Table Styling with Enhanced Typography */
        .admin-table-container {
            background: var(--surface-color);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            overflow-x: auto;
            overflow-y: visible;
            margin-top: var(--spacing-lg);
            border: 1px solid var(--border-color);
            width: 100%;
            max-width: 100%;
        }

        .admin-table {
            width: 100%;
            min-width: 1000px;
            border-collapse: collapse;
            font-size: 15px;
            background: var(--surface-color);
            font-family: var(--hebrew-font);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            table-layout: fixed;
        }

        .admin-table thead th {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
            color: var(--text-inverse);
            padding: 18px 12px;
            text-align: right;
            font-weight: 600;
            font-size: 13px;
            border: none;
            position: sticky;
            top: 0;
            z-index: 10;
            letter-spacing: 0.025em;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            white-space: nowrap;
            vertical-align: middle;
        }
        
        /* Specific column widths */
        .admin-table th:nth-child(1) { width: 60px; } /* # */
        .admin-table th:nth-child(2) { width: 200px; } /* Parent name */
        .admin-table th:nth-child(3) { width: 140px; } /* Phone */
        .admin-table th:nth-child(4) { width: 200px; } /* Child name */
        .admin-table th:nth-child(5) { width: 160px; } /* Status */
        .admin-table th:nth-child(6) { width: 240px; } /* Actions */

        .admin-table tbody tr {
            border-bottom: 1px solid var(--border-color);
            transition: all 0.15s ease;
            cursor: pointer;
            background-color: var(--surface-color);
        }

        .admin-table tbody tr:hover {
            background: var(--hover-color);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .admin-table tbody tr:nth-child(even) {
            background: var(--light-bg);
        }

        .admin-table tbody tr:nth-child(even):hover {
            background: var(--hover-color);
        }

        .admin-table td {
            padding: 12px 8px;
            text-align: right;
            vertical-align: middle;
            border: none;
            font-size: 13px;
            line-height: 1.4;
            color: var(--text-primary);
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        /* Specific column styling */
        .admin-table td:nth-child(1) { text-align: center; }
        .admin-table td:nth-child(3) { direction: ltr; text-align: left; }
        .admin-table td:nth-child(5) { text-align: center; }
        .admin-table td:nth-child(6) { text-align: center; }

        .admin-table .row-number {
            font-weight: 700;
            color: var(--text-secondary);
            text-align: center;
            font-family: var(--latin-font);
            font-size: 12px;
            background: var(--surface-secondary);
            border-radius: 4px;
            padding: 4px 8px;
            display: inline-block;
            min-width: 24px;
        }

        .admin-table .account-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
            letter-spacing: -0.01em;
            max-width: 180px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .admin-table .phone-number {
            font-family: var(--latin-font);
            color: var(--text-secondary);
            direction: ltr;
            text-align: left;
            font-weight: 500;
            font-size: 13px;
            background: var(--surface-secondary);
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
            letter-spacing: 0.02em;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .admin-table .child-name {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 14px;
            letter-spacing: -0.01em;
            max-width: 180px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .admin-table .status-cell {
            text-align: center;
        }

        .admin-table .status-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            min-width: 90px;
            height: 28px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }

        /* Status Color Classes - Comprehensive Color Coding */
        
        /* ◊ó◊ì◊© (New) - Blue theme */
        .admin-table .status-new {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        /* ◊†◊®◊©◊ù (Registered) - Green theme */
        .admin-table .status-registered {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        /* ◊†◊®◊©◊ù ◊ó◊ô◊¶◊ï◊†◊ô (External Registration) - Orange theme */
        .admin-table .status-external {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        /* ◊ë◊ô◊ò◊ú (Cancelled) - Red theme */
        .admin-table .status-cancelled {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        /* ◊û◊ó◊õ◊î ◊ú◊©◊ô◊ë◊ï◊• (Waiting for Assignment) - Purple theme */
        .admin-table .status-waiting {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }
        
        /* ◊§◊ï◊ú◊ï◊ê◊§ (Follow-up) - Teal theme */
        .admin-table .status-followup {
            background: linear-gradient(135deg, #14b8a6, #0d9488);
            color: white;
            border: 1px solid rgba(20, 184, 166, 0.3);
        }
        
        /* ◊î◊ï◊ñ◊û◊†◊ï ◊ú◊©◊ô◊¢◊ï◊® ◊†◊°◊ô◊ï◊ü (Invited to Trial) - Amber theme */
        .admin-table .status-trial {
            background: linear-gradient(135deg, #f59e0b, #f97316);
            color: white;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        /* ◊°◊ô◊ô◊ù (Completed) - Emerald theme */
        .admin-table .status-completed {
            background: linear-gradient(135deg, #059669, #047857);
            color: white;
            border: 1px solid rgba(5, 150, 105, 0.3);
        }
        
        /* Hover effects for all status badges */
        .admin-table .status-badge:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        /* Legacy fallback classes for backward compatibility */
        .admin-table .status-active {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .admin-table .status-inactive {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        /* Status Dropdown Styling */
        .status-dropdown {
            position: relative;
            width: 100%;
            min-width: 140px;
        }
        
        .status-dropdown-input {
            width: 100%;
            padding: 6px 32px 6px 8px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 12px;
            font-family: var(--hebrew-font);
            background: #fefefe;
            direction: rtl;
            text-align: right;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
        }
        
        .status-dropdown-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1);
            background: white;
        }
        
        .status-dropdown .dropdown-arrow {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: auto;
            transition: transform 0.2s ease;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            z-index: 2;
        }
        
        .status-dropdown.open .dropdown-arrow {
            transform: translateY(-50%) rotate(180deg);
            color: var(--primary-color);
        }
        
        .status-dropdown .dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e5e7eb;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .status-dropdown.open .dropdown-list {
            display: block;
        }
        
        .status-dropdown .dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.15s ease;
            border-bottom: 1px solid rgba(226, 232, 240, 0.5);
            display: flex;
            align-items: center;
            gap: 8px;
            direction: rtl;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-dropdown .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .status-dropdown .dropdown-item:hover {
            background: #f8fafc;
            transform: translateX(2px);
        }
        
        .status-dropdown .dropdown-item.selected {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
        }
        
        .status-dropdown .status-icon {
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
        }
        
        .status-dropdown .status-label {
            flex: 1;
            text-align: right;
        }

        .admin-table .actions-cell {
            text-align: center;
            white-space: nowrap;
            width: 280px;
            min-width: 280px;
            padding: 12px 8px;
            vertical-align: middle;
        }

        .admin-table .actions-cell > div {
            display: flex !important;
            flex-direction: column !important;
            gap: 6px !important;
            align-items: center !important;
            padding: 6px !important;
        }

        .admin-table .table-btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin: 2px;
            min-width: 80px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            backdrop-filter: blur(4px);
            letter-spacing: 0.025em;
            text-decoration: none;
        }

        .admin-table .table-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .admin-table .table-btn:hover::before {
            left: 100%;
        }



        .admin-table .edit-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            color: white;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .admin-table .edit-btn:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 10px 25px -3px rgba(59, 130, 246, 0.4), 0 4px 6px -2px rgba(59, 130, 246, 0.1);
        }


        .admin-table .save-btn {
            background: linear-gradient(135deg, #10b981 0%, #047857 100%);
            color: white;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .admin-table .save-btn:hover {
            background: linear-gradient(135deg, #059669 0%, #065f46 100%);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 10px 25px -3px rgba(16, 185, 129, 0.4), 0 4px 6px -2px rgba(16, 185, 129, 0.1);
        }


        .admin-table .cancel-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .admin-table .cancel-btn:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 10px 25px -3px rgba(239, 68, 68, 0.4), 0 4px 6px -2px rgba(239, 68, 68, 0.1);
        }


        /* Loading state for buttons */
        .admin-table .table-btn.loading {
            pointer-events: none;
            opacity: 0.8;
        }

        .admin-table .table-btn.loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            margin: auto;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Button press animation */
        .admin-table .table-btn:active {
            transform: scale(0.96) !important;
            transition: transform 0.1s ease;
        }

        /* Subtle glow effect for better visibility */
        .admin-table .table-btn:hover {
            filter: brightness(1.05);
        }

        /* Enhanced focus states for accessibility */
        .admin-table .table-btn:focus-visible {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
            outline: none;
        }

        .admin-table .save-btn:focus-visible {
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.5);
        }

        .admin-table .cancel-btn:focus-visible {
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.5);
        }

        /* WhatsApp Button Styling */
        .whatsapp-btn {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 4px 8px;
            margin-right: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s ease;
            vertical-align: middle;
        }

        .whatsapp-btn:hover {
            background: linear-gradient(135deg, #20BA5A 0%, #0F7A6B 100%);
            transform: translateY(-1px) scale(1.02);
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
        }

        .whatsapp-btn:active {
            transform: translateY(0) scale(0.98);
        }

        .whatsapp-btn svg {
            width: 14px;
            height: 14px;
            fill: currentColor;
        }

        /* WhatsApp Phone Number Cell Layout */
        .phone-cell-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 4px;
        }

        .phone-cell-container .phone-number {
            flex: 1;
            min-width: 120px;
        }

        /* WhatsApp Modal Specific Styling */
        #whatsappModal .modal-content {
            max-width: 500px;
        }

        .whatsapp-modal-header {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            color: white;
            margin: -24px -24px 20px -24px;
            padding: 20px 24px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .whatsapp-modal-header h3 {
            margin: 0;
            color: white;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .whatsapp-modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s ease;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .whatsapp-modal-close:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .whatsapp-contact-info {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-right: 4px solid #25D366;
        }

        .whatsapp-contact-info h4 {
            margin: 0 0 8px 0;
            color: #495057;
            font-size: 14px;
            font-weight: 600;
        }

        .whatsapp-contact-info p {
            margin: 4px 0;
            color: #6c757d;
            font-size: 13px;
        }

        .whatsapp-message-area {
            margin-bottom: 20px;
        }

        .whatsapp-message-area label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 14px;
        }

        .whatsapp-message-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            direction: rtl;
            text-align: right;
            transition: border-color 0.2s ease;
        }

        .whatsapp-message-textarea:focus {
            outline: none;
            border-color: #25D366;
            box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.1);
        }

        .whatsapp-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .whatsapp-send-btn {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .whatsapp-send-btn:hover {
            background: linear-gradient(135deg, #20BA5A 0%, #0F7A6B 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
        }

        .whatsapp-send-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .whatsapp-cancel-btn {
            background: #f8f9fa;
            color: #6c757d;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .whatsapp-cancel-btn:hover {
            background: #e9ecef;
            color: #495057;
            border-color: #adb5bd;
        }

        /* Responsive WhatsApp Styling */
        @media (max-width: 768px) {
            .whatsapp-btn {
                font-size: 10px;
                padding: 3px 6px;
            }

            .whatsapp-btn svg {
                width: 12px;
                height: 12px;
            }

            .phone-cell-container {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
            }

            .whatsapp-actions {
                flex-direction: column;
            }

            .whatsapp-send-btn,
            .whatsapp-cancel-btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* Spinning animation for loading state */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .admin-table .edit-input {
            width: 100%;
            border: 2px solid var(--border-color);
            padding: 10px 12px;
            font-size: 14px;
            border-radius: 6px;
            background: var(--surface-color);
            transition: all 0.2s ease;
            font-family: var(--hebrew-font);
            color: var(--text-primary);
            font-weight: 500;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .admin-table .edit-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
            background: var(--surface-elevated);
        }

        .admin-table .edit-select {
            width: 100%;
            border: 2px solid var(--border-color);
            padding: 10px 12px;
            font-size: 14px;
            border-radius: 6px;
            background: var(--surface-color);
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: var(--hebrew-font);
            color: var(--text-primary);
            font-weight: 500;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .admin-table .edit-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
            background: var(--surface-elevated);
        }

        /* Additional typography improvements */
        .admin-table .status-text {
            font-weight: 600;
            font-size: 13px;
            letter-spacing: 0.025em;
        }

        /* Enhanced typography for better readability */
        .admin-table .display-mode {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }

        /* Improved button typography */
        .admin-table .table-btn {
            font-family: var(--hebrew-font);
            font-weight: 600;
            letter-spacing: 0.025em;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Enhanced registration count display */
        #registrationsCount {
            font-family: var(--hebrew-font);
            font-weight: 600;
            font-size: 16px;
            color: var(--text-primary);
            background: var(--surface-secondary);
            padding: 12px 16px;
            border-radius: var(--radius-md);
            border-left: 4px solid var(--primary-color);
        }

        /* Better title typography */
        #registrationsTitle {
            font-family: var(--hebrew-font);
            font-weight: 700;
            font-size: 20px;
            color: var(--text-primary);
            letter-spacing: -0.02em;
            margin-bottom: var(--spacing-md);
        }

        /* Professional loading states */
        .loading {
            font-family: var(--hebrew-font);
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 15px;
        }

        /* Table border and separation improvements */
        .admin-table th,
        .admin-table td {
            border-right: 1px solid var(--border-color);
        }
        
        .admin-table th:last-child,
        .admin-table td:last-child {
            border-right: none;
        }
        
        /* Enhanced responsive table with horizontal scroll */
        @media (max-width: 1200px) {
            .admin-table-container {
                overflow-x: auto;
                overflow-y: visible;
                width: 100%;
                -webkit-overflow-scrolling: touch;
                position: relative;
            }
            
            .admin-table {
                min-width: 1000px;
            }
        }
        
        @media (max-width: 768px) {
            .admin-table-container {
                overflow-x: auto;
                border-radius: var(--radius-md);
                margin: var(--spacing-md) -var(--spacing-lg) 0;
                box-shadow: var(--shadow-md);
            }

            .admin-table {
                min-width: 1000px;
            }

            .admin-table thead th {
                padding: 12px 8px;
                font-size: 12px;
            }
            
            .admin-table td {
                padding: 10px 6px;
                font-size: 12px;
            }

            .admin-table .account-name,
            .admin-table .child-name {
                font-size: 13px;
            }

            .admin-table .phone-number {
                font-size: 12px;
            }

            .admin-table .table-btn {
                padding: 8px 12px;
                font-size: 11px;
                min-width: 65px;
                margin: 0.5px;
            }

            .admin-table .actions-cell {
                width: 200px;
                min-width: 200px;
                padding: 8px 4px;
            }

            .admin-table .actions-cell > div {
                gap: 4px !important;
                padding: 4px !important;
            }

            .admin-table .row-number {
                font-size: 11px;
                padding: 3px 6px;
            }
            
            .admin-table .status-badge {
                font-size: 10px;
                padding: 6px 8px;
                min-width: 70px;
                height: 24px;
            }
        }
        
        /* Horizontal scroll indicator */
        .admin-table-container::after {
            content: '‚Üê ◊í◊ú◊ï◊ú ◊ú◊®◊ê◊ô◊î ◊û◊ú◊ê◊î ‚Üí';
            display: none;
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 20;
        }
        
        @media (max-width: 1200px) {
            .admin-table-container {
                position: relative;
            }
            
            .admin-table-container::after {
                display: block;
            }
        }

        /* High DPI displays optimization */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .admin-table {
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }
            
            .admin-table .account-name,
            .admin-table .child-name {
                text-shadow: 0 0.5px 1px rgba(0, 0, 0, 0.05);
            }
        }

        /* Modern Navigation System */
        .app-navigation {
            background: var(--nav-bg);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            padding: 0;
            margin: 0;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            padding: 0 var(--spacing-lg);
        }

        .nav-brand {
            color: white;
            font-size: 20px;
            font-weight: 700;
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .nav-tabs {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
            gap: 0;
        }

        .nav-tab {
            position: relative;
        }

        .nav-tab-button {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.9);
            padding: var(--spacing-md) var(--spacing-lg);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-family: var(--hebrew-font);
            font-size: 16px;
            font-weight: 600;
            text-decoration: none;
            position: relative;
            min-height: 60px;
            border-radius: 0;
        }

        .nav-tab-button:hover {
            background: var(--nav-hover);
            color: white;
            transform: translateY(-1px);
        }

        .nav-tab-button.active {
            background: var(--nav-active);
            color: white;
            box-shadow: inset 0 -3px 0 white;
        }

        .nav-tab-button.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: white;
            border-radius: 3px 3px 0 0;
        }

        .nav-icon {
            font-size: 18px;
            transition: transform 0.2s ease;
        }

        .nav-tab-button:hover .nav-icon {
            transform: scale(1.1);
        }

        /* Page Content Styling */
        .page-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .page-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Page Headers */
        .page-title {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: var(--spacing-xl) 0;
            text-align: center;
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--shadow-md);
        }

        .page-title h1 {
            color: white;
            -webkit-text-fill-color: white;
            background: none;
            margin-bottom: var(--spacing-sm);
        }

        .page-title h1::before {
            color: #ffd700;
        }

        .page-title h1::after {
            background: rgba(255, 255, 255, 0.3);
        }

        .page-title .subtitle {
            font-size: 16px;
            opacity: 0.9;
            font-weight: 400;
            margin-top: var(--spacing-sm);
        }

        /* Responsive Navigation */
        .nav-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: var(--spacing-sm);
        }

        @media (max-width: 768px) {
            .nav-container {
                flex-wrap: wrap;
                padding: 0 var(--spacing-md);
            }

            .nav-brand {
                margin-left: 0;
                margin-right: auto;
                font-size: 18px;
            }

            .nav-toggle {
                display: block;
                order: 3;
            }

            .nav-tabs {
                order: 4;
                width: 100%;
                flex-direction: column;
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.3s ease;
                background: rgba(0, 0, 0, 0.1);
            }

            .nav-tabs.active {
                max-height: 300px;
            }

            .nav-tab-button {
                width: 100%;
                padding: var(--spacing-md) var(--spacing-lg);
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                justify-content: flex-end;
                min-height: 50px;
            }

            .nav-tab-button.active::after {
                display: none;
            }

            .nav-tab-button.active {
                box-shadow: inset 3px 0 0 white;
            }

            .page-title {
                padding: var(--spacing-lg) 0;
            }

            .page-title h1 {
                font-size: 24px;
            }
        }

        /* Premium Section Updates for Pages */
        .page-section {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            padding: var(--spacing-xl);
            margin: var(--spacing-lg) auto;
            max-width: 1200px;
            position: relative;
            overflow: hidden;
        }

        .page-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color), var(--accent-color));
        }

        /* Update main content layout */
        .main-content {
            padding: 0 var(--spacing-lg);
            margin: 0 auto;
            max-width: none;
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 0 var(--spacing-md);
            }

            .page-section {
                margin: var(--spacing-md) 0;
                padding: var(--spacing-lg);
            }
        }
    </style>
</head>
<body>
    <!-- Modern Navigation System -->
    <nav class="app-navigation">
        <div class="nav-container">
            <div class="nav-brand">
                <span class="nav-icon">üëë</span>
                ◊®◊ô◊©◊ï◊ù ◊§◊¢◊ô◊ú◊ï◊ô◊ï◊™ ◊ó◊ô◊†◊ï◊õ◊ô◊ï◊™
            </div>
            
            <button class="nav-toggle" onclick="toggleMobileNav()">‚ò∞</button>
            
            <ul class="nav-tabs" id="navTabs">
                <li class="nav-tab">
                    <button class="nav-tab-button active" onclick="switchPage('registration')" data-page="registration">
                        <span class="nav-icon">üìù</span>
                        ◊®◊ô◊©◊ï◊ù ◊ó◊ì◊©
                    </button>
                </li>
                <li class="nav-tab">
                    <button class="nav-tab-button" onclick="switchPage('management')" data-page="management">
                        <span class="nav-icon">üë®‚Äçüíº</span>
                        ◊†◊ô◊î◊ï◊ú ◊®◊ô◊©◊ï◊û◊ô◊ù
                    </button>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Page 1: New Registration -->
    <div id="registrationPage" class="page-content active">
        <div class="page-title">
            <h1>◊®◊ô◊©◊ï◊ù ◊ó◊ì◊©</h1>
            <div class="subtitle">◊ò◊ï◊§◊° ◊®◊ô◊©◊ï◊ù ◊ú◊§◊¢◊ô◊ú◊ï◊ô◊ï◊™ ◊ó◊ô◊†◊ï◊õ◊ô◊ï◊™ ◊û◊™◊ß◊ì◊û◊ï◊™</div>
        </div>
        
        <div class="main-content">
            <div class="page-section">
                <h2>◊§◊®◊ò◊ô ◊î◊®◊ô◊©◊ï◊ù</h2>
                
                <form id="registrationForm">
                    <div class="form-container">
                        <div class="form-group">
                            <label for="parentName">◊©◊ù ◊î◊î◊ï◊®◊î *</label>
                            <input type="text" id="parentName" name="parentName" required>
                        </div>

                        <div class="form-group">
                            <label for="phoneNumber">◊û◊°◊§◊® ◊ò◊ú◊§◊ï◊ü *</label>
                            <input type="tel" id="phoneNumber" name="phoneNumber" required>
                        </div>

                        <div class="form-group">
                            <label for="childName">◊©◊ù ◊î◊ô◊ú◊ì/◊î *</label>
                            <input type="text" id="childName" name="childName" required>
                        </div>

                        <div class="form-group">
                            <label for="childBirthDate">◊™◊ê◊®◊ô◊ö ◊ú◊ô◊ì◊™ ◊î◊ô◊ú◊ì/◊î</label>
                            <input type="date" id="childBirthDate" name="childBirthDate">
                        </div>

                        <div class="form-group">
                            <label for="email">◊õ◊™◊ï◊ë◊™ ◊ê◊ô◊û◊ô◊ô◊ú</label>
                            <input type="email" id="email" name="email">
                        </div>

                        <div class="form-group full-width">
                            <label for="programCycle">◊û◊ó◊ñ◊ï◊® ◊™◊ï◊õ◊†◊ô◊™ *</label>
                            <div class="modern-dropdown" id="cycleDropdown">
                                <input type="text" 
                                       id="programCycle" 
                                       name="programCycle" 
                                       class="dropdown-input" 
                                       placeholder="◊î◊ß◊ú◊ì ◊ú◊ó◊ô◊§◊ï◊© ◊û◊ó◊ñ◊ï◊® ◊ê◊ï ◊ë◊ó◊® ◊û◊î◊®◊©◊ô◊û◊î..." 
                                       autocomplete="off"
                                       required>
                                <div class="dropdown-arrow">‚ñº</div>
                                <div class="dropdown-list" id="cycleDropdownList">
                                    <div class="dropdown-loading">
                                        <div class="spinner"></div>
                                        ◊ò◊ï◊¢◊ü ◊û◊ó◊ñ◊ï◊®◊ô◊ù...
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" id="selectedCycleId" name="selectedCycleId" required>
                            <div id="cycleError" class="error" style="display: none;"></div>
                        </div>

                        <div class="form-group full-width" style="margin-top: var(--spacing-lg);">
                            <button type="submit" class="submit-btn" id="submitBtn">◊©◊ú◊ó ◊®◊ô◊©◊ï◊ù</button>
                        </div>
                        
                        <div class="form-group full-width" style="margin-top: var(--spacing-md); text-align: center;">
                            <a href="https://pages.greeninvoice.co.il/payments/links/a81eeaab-4b27-4910-8ffe-864ded9a0567" 
                               target="_blank" 
                               class="payment-btn">
                               ◊¢◊ë◊ï◊® ◊ú◊™◊©◊ú◊ï◊ù
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Page 2: Registration Management -->
    <div id="managementPage" class="page-content">
        <div class="page-title">
            <h1>◊†◊ô◊î◊ï◊ú ◊®◊ô◊©◊ï◊û◊ô◊ù</h1>
            <div class="subtitle">◊û◊¢◊®◊õ◊™ ◊†◊ô◊î◊ï◊ú ◊®◊ô◊©◊ï◊û◊ô◊ù ◊û◊™◊ß◊ì◊û◊™</div>
        </div>
        
        <div class="main-content">
            <div class="page-section" id="adminSection">
                <h2>◊ë◊ó◊ô◊®◊™ ◊û◊ó◊ñ◊ï◊® ◊ú◊†◊ô◊î◊ï◊ú</h2>
                
                <div class="form-container">
                    <div class="form-group span-2">
                        <label for="adminCycleSelect">◊ë◊ó◊® ◊û◊ó◊ñ◊ï◊® ◊ú◊¶◊§◊ô◊ô◊î:</label>
                        <div class="modern-dropdown" id="adminCycleDropdown">
                            <input type="text" 
                                   id="adminCycleSelect" 
                                   name="adminCycleSelect" 
                                   class="dropdown-input" 
                                   placeholder="◊î◊ß◊ú◊ì ◊ú◊ó◊ô◊§◊ï◊© ◊û◊ó◊ñ◊ï◊® ◊ê◊ï ◊ë◊ó◊® ◊û◊î◊®◊©◊ô◊û◊î..." 
                                   autocomplete="off">
                            <div class="dropdown-arrow">‚ñº</div>
                            <div class="dropdown-list" id="adminCycleDropdownList">
                                <div class="dropdown-loading">
                                    <div class="spinner"></div>
                                    ◊ò◊ï◊¢◊ü ◊û◊ó◊ñ◊ï◊®◊ô◊ù...
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="selectedAdminCycleId" name="selectedAdminCycleId">
                    </div>
                    
                    <div class="form-group full-width">
                        <button type="button" class="submit-btn" id="fetchRegistrationsBtn" style="margin-bottom: 20px;">
                            ◊î◊¶◊í ◊®◊ô◊©◊ï◊û◊ô◊ù
                        </button>
                    </div>
                </div>
                
                <div id="registrationsResults" style="display: none;">
                    <h3 id="registrationsTitle">◊®◊ô◊©◊ï◊û◊ô◊ù ◊ú◊û◊ó◊ñ◊ï◊®:</h3>
                    <div id="registrationsCount" style="margin-bottom: 15px; font-weight: bold;"></div>
                    <div id="registrationsList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Registration Details Modal -->
    <div id="registrationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>◊§◊®◊ò◊ô ◊®◊ô◊©◊ï◊ù</h3>
                <button class="modal-close" onclick="closeRegistrationModal()">&times;</button>
            </div>

            <div id="modalContent">
                <!-- Content will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- WhatsApp Message Modal -->
    <div id="whatsappModal" class="modal">
        <div class="modal-content">
            <div class="whatsapp-modal-header">
                <h3>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
                    </svg>
                    ◊©◊ú◊ó ◊î◊ï◊ì◊¢◊î ◊ë-WhatsApp
                </h3>
                <button class="whatsapp-modal-close" onclick="closeWhatsAppModal()">&times;</button>
            </div>

            <div class="whatsapp-contact-info" id="whatsappContactInfo">
                <!-- Contact info will be populated dynamically -->
            </div>

            <div class="whatsapp-message-area">
                <label for="whatsappMessage">◊î◊ï◊ì◊¢◊î:</label>
                <textarea id="whatsappMessage" class="whatsapp-message-textarea" placeholder="◊î◊ß◊ú◊ì ◊ê◊™ ◊î◊î◊ï◊ì◊¢◊î ◊©◊ë◊®◊¶◊ï◊†◊ö ◊ú◊©◊ú◊ï◊ó..."></textarea>
            </div>

            <div class="whatsapp-actions">
                <button class="whatsapp-send-btn" onclick="sendWhatsAppMessage()" id="whatsappSendBtn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                    ◊©◊ú◊ó ◊î◊ï◊ì◊¢◊î
                </button>
                <button class="whatsapp-cancel-btn" onclick="closeWhatsAppModal()">
                    ◊ë◊ò◊ú
                </button>
            </div>
        </div>
    </div>

    <!-- Client-side Rate Limiting and Request Management -->
    <script src="utils/clientRateLimiter.js"></script>

    <script>
        // Navigation System - Define first for immediate availability
        window.switchPage = function switchPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show selected page
            const targetPage = document.getElementById(pageId + 'Page');
            if (targetPage) {
                targetPage.classList.add('active');
            }
            
            // Update navigation active state
            document.querySelectorAll('.nav-tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const activeBtn = document.querySelector(`[data-page="${pageId}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
            
            // Close mobile nav if open
            const navTabs = document.getElementById('navTabs');
            if (navTabs) {
                navTabs.classList.remove('active');
            }
            
            // Special handling for management page
            if (pageId === 'management') {
                // Ensure admin cycles are loaded when switching to management page
                if (adminModernDropdown && adminModernDropdown.adminCycles.length === 0) {
                    populateAdminCyclesDropdown().catch(error => {
                        console.log('Error loading admin cycles on page switch:', error);
                    });
                }
            }
        };

        function toggleMobileNav() {
            const navTabs = document.getElementById('navTabs');
            if (navTabs) {
                navTabs.classList.toggle('active');
            }
        }

        // Close mobile nav when clicking outside
        document.addEventListener('click', function(e) {
            const navTabs = document.getElementById('navTabs');
            const navToggle = document.querySelector('.nav-toggle');
            
            if (navTabs && navToggle && 
                !navTabs.contains(e.target) && 
                !navToggle.contains(e.target) &&
                navTabs.classList.contains('active')) {
                navTabs.classList.remove('active');
            }
        });

        // Token is now handled securely on the server-side
        let allCycles = []; // Store all cycles for filtering
        let statusOptions = []; // Store status options from Fireberry
        let currentRegistrations = []; // Store current registrations for modal access
        
        // Modern dropdown state
        let filteredCycles = []; // Store filtered results
        let highlightedIndex = -1; // For keyboard navigation
        let selectedCycle = null; // Currently selected cycle
        let recentSelections = JSON.parse(localStorage.getItem('recentCycleSelections') || '[]');
        let searchTimeout = null; // For debounced search
        
        // Enhanced fetch active cycles with rate limiting and error handling
        async function fetchActiveCycles() {
            const cycleError = document.getElementById('cycleError');
            
            try {
                let data;
                
                // Check if rate limiter is available, fallback to regular fetch if not
                if (window.clientRateLimiter && window.requestCancellation) {
                    // Use rate-limited and cached request
                    const cacheKey = 'active_cycles';
                    data = await window.clientRateLimiter.executeRequest(async () => {
                        const response = await window.requestCancellation.fetch('/api/cycles', {}, 'fetch_cycles');
                        
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            throw new Error(errorData.message || `HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        return await response.json();
                    }, cacheKey);
                } else {
                    console.warn('[Frontend] Rate limiter not available, using fallback fetch');
                    const response = await fetch('/api/cycles');
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    data = await response.json();
                }
                
                if (data.cycles && data.cycles.length > 0) {
                    allCycles = data.cycles; // Store all cycles
                    console.log(`[Frontend] Loaded ${allCycles.length} active cycles (cached: ${data.fromCache})`);
                    
                    // Update modern dropdown if initialized
                    if (modernDropdown) {
                        modernDropdown.updateItems(allCycles);
                    }
                    
                    // Populate admin dropdown in background (don't await to avoid blocking)
                    populateAdminCyclesDropdown().catch(error => {
                        console.log('[Frontend] Error populating admin cycles:', error);
                        if (adminModernDropdown) {
                            adminModernDropdown.updateAdminCycles([]);
                        }
                    });
                } else {
                    // Show error in dropdown
                    if (modernDropdown) {
                        modernDropdown.list.innerHTML = '<div class="dropdown-empty">◊ê◊ô◊ü ◊û◊ó◊ñ◊ï◊®◊ô◊ù ◊ñ◊û◊ô◊†◊ô◊ù ◊õ◊®◊í◊¢</div>';
                    }
                }
                
                if (cycleError) {
                    cycleError.style.display = 'none';
                }
                
            } catch (error) {
                console.error('[Frontend] Error fetching cycles:', error);
                
                if (cycleError) {
                    // Use enhanced error handling if available
                    if (window.ErrorHandler) {
                        window.ErrorHandler.displayError(cycleError, error, '◊ò◊¢◊ô◊†◊™ ◊û◊ó◊ñ◊ï◊®◊ô◊ù');
                        
                        // Add retry functionality
                        cycleError.addEventListener('retry', async () => {
                            console.log('[Frontend] Retrying cycles fetch...');
                            await fetchActiveCycles();
                        }, { once: true });
                    } else {
                        // Fallback error display
                        cycleError.innerHTML = `<div style="color: #e74c3c; padding: 10px; text-align: center;">‚ùå ◊©◊í◊ô◊ê◊î ◊ë◊ò◊¢◊ô◊†◊™ ◊î◊û◊ó◊ñ◊ï◊®◊ô◊ù: ${error.message}</div>`;
                        cycleError.style.display = 'block';
                    }
                }
                
                // Fallback with dummy data for development after delay
                setTimeout(() => {
                    console.log('[Frontend] Using fallback data for development');
                    allCycles = [
                        { id: 'cycle1', name: '◊û◊ó◊ñ◊ï◊® ◊ß◊ô◊• 2024' },
                        { id: 'cycle2', name: '◊û◊ó◊ñ◊ï◊® ◊°◊™◊ô◊ï 2024' },
                        { id: 'cycle3', name: '◊û◊ó◊ñ◊ï◊® ◊ó◊ï◊®◊£ 2024' }
                    ];
                    
                    // Update modern dropdown
                    if (modernDropdown) {
                        modernDropdown.updateItems(allCycles);
                    }
                    
                    // Populate admin dropdown in background
                    populateAdminCyclesDropdown().catch(error => {
                        console.log('[Frontend] Error populating admin cycles with fallback:', error);
                    });
                }, 2000);
            }
        }

        // Populate cycles dropdown with filtered results
        function populateCyclesDropdown(cycles) {
            const cycleSelect = document.getElementById('programCycle');
            cycleSelect.innerHTML = '<option value="">◊ë◊ó◊® ◊û◊ó◊ñ◊ï◊® ◊™◊ï◊õ◊†◊ô◊™</option>';
            
            cycles.forEach(cycle => {
                const option = document.createElement('option');
                option.value = cycle.id;
                option.textContent = cycle.name;
                cycleSelect.appendChild(option);
            });
        }

        // Modern Dropdown Implementation
        class ModernDropdown {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
                this.input = this.container.querySelector('.dropdown-input');
                this.list = this.container.querySelector('.dropdown-list');
                this.arrow = this.container.querySelector('.dropdown-arrow');
                this.hiddenInput = document.getElementById('selectedCycleId');
                this.isOpen = false;
                this.highlightedIndex = -1;
                this.filteredItems = [];
                this.virtualStart = 0;
                this.virtualEnd = 20; // Show 20 items at a time
                this.itemHeight = 45; // Approximate height per item
                
                this.init();
            }
            
            init() {
                // Input event handlers
                this.input.addEventListener('input', (e) => this.handleInput(e));
                this.input.addEventListener('focus', () => this.open());
                this.input.addEventListener('blur', (e) => this.handleBlur(e));
                this.input.addEventListener('keydown', (e) => this.handleKeydown(e));
                
                // Click outside to close
                document.addEventListener('click', (e) => {
                    if (!this.container.contains(e.target)) {
                        this.close();
                    }
                });
                
                // Arrow click
                this.arrow.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.isOpen ? this.close() : this.open();
                });
                
                // Scroll handler for virtual scrolling
                this.list.addEventListener('scroll', () => this.handleScroll());
            }
            
            handleInput(e) {
                const value = e.target.value;
                
                // Clear timeout for debounced search
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }
                
                // Debounced search (300ms delay)
                searchTimeout = setTimeout(() => {
                    this.filterItems(value);
                    if (!this.isOpen && value) {
                        this.open();
                    }
                }, 300);
                
                // Clear selection if input changes
                if (selectedCycle && value !== selectedCycle.name) {
                    selectedCycle = null;
                    this.hiddenInput.value = '';
                }
            }
            
            handleKeydown(e) {
                if (!this.isOpen) {
                    if (e.key === 'ArrowDown' || e.key === 'Enter') {
                        e.preventDefault();
                        this.open();
                    }
                    return;
                }
                
                switch (e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        this.highlightNext();
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        this.highlightPrev();
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (this.highlightedIndex >= 0) {
                            this.selectItem(this.filteredItems[this.highlightedIndex]);
                        }
                        break;
                    case 'Escape':
                        e.preventDefault();
                        this.close();
                        break;
                    case 'Tab':
                        this.close();
                        break;
                }
            }
            
            handleBlur(e) {
                // Delay close to allow clicking on items
                setTimeout(() => {
                    if (!this.container.contains(document.activeElement)) {
                        this.close();
                    }
                }, 150);
            }
            
            handleScroll() {
                // Virtual scrolling for performance with large lists
                const scrollTop = this.list.scrollTop;
                const visibleStart = Math.floor(scrollTop / this.itemHeight);
                const visibleEnd = Math.min(visibleStart + Math.ceil(this.list.clientHeight / this.itemHeight) + 5, this.filteredItems.length);
                
                if (visibleStart !== this.virtualStart || visibleEnd !== this.virtualEnd) {
                    this.virtualStart = visibleStart;
                    this.virtualEnd = visibleEnd;
                    this.renderItems();
                }
            }
            
            filterItems(searchTerm) {
                if (!searchTerm.trim()) {
                    this.filteredItems = [...allCycles];
                } else {
                    const term = searchTerm.toLowerCase().trim();
                    this.filteredItems = allCycles.filter(cycle => 
                        cycle.name.toLowerCase().includes(term)
                    );
                }
                
                this.highlightedIndex = -1;
                this.virtualStart = 0;
                this.virtualEnd = Math.min(20, this.filteredItems.length);
                this.renderItems();
            }
            
            renderItems() {
                if (this.filteredItems.length === 0) {
                    this.list.innerHTML = `
                        <div class=\"dropdown-empty\">
                            üîç ◊ú◊ê ◊†◊û◊¶◊ê◊ï ◊™◊ï◊¶◊ê◊ï◊™
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                
                // Add recent selections section if we have recent items and no search
                if (recentSelections.length > 0 && !this.input.value.trim()) {
                    html += '<div class=\"dropdown-section\">◊ë◊ó◊ô◊®◊ï◊™ ◊ê◊ó◊®◊ï◊†◊ï◊™</div>';
                    
                    recentSelections.slice(0, 3).forEach((recentId, index) => {
                        const cycle = allCycles.find(c => c.id === recentId);
                        if (cycle) {
                            const isHighlighted = index === this.highlightedIndex;
                            html += this.renderItem(cycle, isHighlighted, true, index);
                        }
                    });
                    
                    if (this.filteredItems.length > recentSelections.length) {
                        html += '<div class=\"dropdown-section\">◊õ◊ú ◊î◊û◊ó◊ñ◊ï◊®◊ô◊ù</div>';
                    }
                }
                
                // Virtual scrolling implementation
                const totalHeight = this.filteredItems.length * this.itemHeight;
                const offsetY = this.virtualStart * this.itemHeight;
                
                // Add spacer for items before visible range
                if (this.virtualStart > 0) {
                    html += `<div style=\"height: ${offsetY}px;\"></div>`;
                }
                
                // Render visible items
                const recentCount = recentSelections.length > 0 && !this.input.value.trim() ? 3 : 0;
                for (let i = this.virtualStart; i < this.virtualEnd; i++) {
                    const cycle = this.filteredItems[i];
                    if (cycle) {
                        const adjustedIndex = recentCount > 0 ? i + recentCount : i;
                        const isHighlighted = adjustedIndex === this.highlightedIndex;
                        const isRecent = false;
                        html += this.renderItem(cycle, isHighlighted, isRecent, adjustedIndex);
                    }
                }
                
                // Add spacer for items after visible range
                const remainingHeight = totalHeight - ((this.virtualEnd) * this.itemHeight);
                if (remainingHeight > 0) {
                    html += `<div style="height: ${remainingHeight}px;"></div>`;
                }
                
                this.list.innerHTML = html;
                
                // Add click handlers to items
                this.list.querySelectorAll('.dropdown-item').forEach((item, index) => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const cycleId = item.getAttribute('data-cycle-id');
                        const cycle = allCycles.find(c => c.id === cycleId);
                        if (cycle) {
                            this.selectItem(cycle);
                        }
                    });
                });
            }
            
            renderItem(cycle, isHighlighted, isRecent, index) {
                const searchTerm = this.input.value.toLowerCase().trim();
                let displayName = cycle.name;
                
                // Highlight search terms
                if (searchTerm && !isRecent) {
                    const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&')})`, 'gi');
                    displayName = displayName.replace(regex, '<span class="highlight">$1</span>');
                }
                
                const recentBadge = isRecent ? '<span class="item-badge">◊ê◊ó◊®◊ï◊ü</span>' : '';
                const highlightClass = isHighlighted ? 'highlighted' : '';
                
                return `
                    <div class="dropdown-item ${highlightClass}" data-cycle-id="${cycle.id}" data-index="${index}">
                        <div class="item-text">${displayName}</div>
                        ${recentBadge}
                    </div>
                `;
            }
            
            highlightNext() {
                const maxIndex = this.getMaxHighlightIndex();
                this.highlightedIndex = Math.min(this.highlightedIndex + 1, maxIndex);
                this.updateHighlight();
                this.scrollToHighlighted();
            }
            
            highlightPrev() {
                this.highlightedIndex = Math.max(this.highlightedIndex - 1, 0);
                this.updateHighlight();
                this.scrollToHighlighted();
            }
            
            getMaxHighlightIndex() {
                const recentCount = recentSelections.length > 0 && !this.input.value.trim() ? Math.min(3, recentSelections.length) : 0;
                return recentCount + this.filteredItems.length - 1;
            }
            
            updateHighlight() {
                this.list.querySelectorAll('.dropdown-item').forEach((item, index) => {
                    const itemIndex = parseInt(item.getAttribute('data-index'));
                    if (itemIndex === this.highlightedIndex) {
                        item.classList.add('highlighted');
                    } else {
                        item.classList.remove('highlighted');
                    }
                });
            }
            
            scrollToHighlighted() {
                const highlightedItem = this.list.querySelector('.dropdown-item.highlighted');
                if (highlightedItem) {
                    const listRect = this.list.getBoundingClientRect();
                    const itemRect = highlightedItem.getBoundingClientRect();
                    
                    if (itemRect.bottom > listRect.bottom) {
                        highlightedItem.scrollIntoView({ block: 'end', behavior: 'smooth' });
                    } else if (itemRect.top < listRect.top) {
                        highlightedItem.scrollIntoView({ block: 'start', behavior: 'smooth' });
                    }
                }
            }
            
            selectItem(cycle) {
                selectedCycle = cycle;
                this.input.value = cycle.name;
                this.hiddenInput.value = cycle.id;
                
                // Add to recent selections
                this.addToRecent(cycle.id);
                
                // Clear any error state
                const errorDiv = document.getElementById('cycleError');
                if (errorDiv) {
                    errorDiv.style.display = 'none';
                }
                
                this.close();
                
                // Trigger change event for form validation
                this.input.dispatchEvent(new Event('change', { bubbles: true }));
            }
            
            addToRecent(cycleId) {
                // Remove if already exists
                recentSelections = recentSelections.filter(id => id !== cycleId);
                // Add to beginning
                recentSelections.unshift(cycleId);
                // Keep only last 5
                recentSelections = recentSelections.slice(0, 5);
                // Save to localStorage
                localStorage.setItem('recentCycleSelections', JSON.stringify(recentSelections));
            }
            
            open() {
                if (this.isOpen) return;
                
                this.isOpen = true;
                this.container.classList.add('open');
                
                // Load items if not already loaded
                if (allCycles.length === 0) {
                    this.showLoading();
                    fetchActiveCycles().then(() => {
                        this.filterItems(this.input.value);
                    });
                } else {
                    this.filterItems(this.input.value);
                }
            }
            
            close() {
                if (!this.isOpen) return;
                
                this.isOpen = false;
                this.container.classList.remove('open');
                this.highlightedIndex = -1;
            }
            
            showLoading() {
                this.list.innerHTML = `
                    <div class="dropdown-loading">
                        <div class="spinner"></div>
                        ◊ò◊ï◊¢◊ü ◊û◊ó◊ñ◊ï◊®◊ô◊ù...
                    </div>
                `;
            }
            
            updateItems(cycles) {
                allCycles = cycles;
                if (this.isOpen) {
                    this.filterItems(this.input.value);
                }
            }
        }
        
        // Initialize modern dropdown
        let modernDropdown;
        let adminModernDropdown;
        
        // Admin Modern Dropdown Implementation - specialized for admin cycles with registration counts
        class AdminModernDropdown extends ModernDropdown {
            constructor(containerId) {
                super(containerId);
                this.hiddenInput = document.getElementById('selectedAdminCycleId');
                this.adminCycles = []; // Store admin-specific data
                this.recentAdminSelections = JSON.parse(localStorage.getItem('recentAdminCycleSelections') || '[]');
            }
            
            updateAdminCycles(cycles) {
                this.adminCycles = cycles;
                if (this.isOpen) {
                    this.filterItems(this.input.value);
                }
            }
            
            filterItems(searchTerm) {
                if (!searchTerm.trim()) {
                    this.filteredItems = [...this.adminCycles];
                } else {
                    const term = searchTerm.toLowerCase().trim();
                    this.filteredItems = this.adminCycles.filter(cycle => 
                        cycle.name.toLowerCase().includes(term)
                    );
                }
                
                this.highlightedIndex = -1;
                this.virtualStart = 0;
                this.virtualEnd = Math.min(20, this.filteredItems.length);
                this.renderItems();
            }
            
            renderItems() {
                if (this.filteredItems.length === 0) {
                    this.list.innerHTML = `
                        <div class="dropdown-empty">
                            üîç ◊ú◊ê ◊†◊û◊¶◊ê◊ï ◊™◊ï◊¶◊ê◊ï◊™
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                
                // Add recent selections section if we have recent items and no search
                if (this.recentAdminSelections.length > 0 && !this.input.value.trim()) {
                    html += '<div class="dropdown-section">◊ë◊ó◊ô◊®◊ï◊™ ◊ê◊ó◊®◊ï◊†◊ï◊™</div>';
                    
                    this.recentAdminSelections.slice(0, 3).forEach((recentId, index) => {
                        const cycle = this.adminCycles.find(c => c.id === recentId);
                        if (cycle) {
                            const isHighlighted = index === this.highlightedIndex;
                            html += this.renderAdminItem(cycle, isHighlighted, true, index);
                        }
                    });
                    
                    if (this.filteredItems.length > this.recentAdminSelections.length) {
                        html += '<div class="dropdown-section">◊õ◊ú ◊î◊û◊ó◊ñ◊ï◊®◊ô◊ù</div>';
                    }
                }
                
                // Render filtered items with registration counts
                this.filteredItems.forEach((cycle, index) => {
                    const adjustedIndex = this.recentAdminSelections.length > 0 && !this.input.value.trim() ? 
                        index + Math.min(3, this.recentAdminSelections.length) : index;
                    const isHighlighted = adjustedIndex === this.highlightedIndex;
                    const isRecent = this.recentAdminSelections.length > 0 && !this.input.value.trim() && 
                        this.recentAdminSelections.includes(cycle.id);
                    
                    if (!isRecent) {
                        html += this.renderAdminItem(cycle, isHighlighted, false, adjustedIndex);
                    }
                });
                
                this.list.innerHTML = html;
                
                // Add click handlers
                this.list.querySelectorAll('.dropdown-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const cycleId = item.getAttribute('data-cycle-id');
                        const cycle = this.adminCycles.find(c => c.id === cycleId);
                        if (cycle) {
                            this.selectAdminItem(cycle);
                        }
                    });
                });
            }
            
            renderAdminItem(cycle, isHighlighted, isRecent, index) {
                const searchTerm = this.input.value.toLowerCase().trim();
                let displayName = cycle.name;
                
                // Highlight search terms
                if (searchTerm && !isRecent) {
                    const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&')})`, 'gi');
                    displayName = displayName.replace(regex, '<span class="highlight">$1</span>');
                }
                
                const recentBadge = isRecent ? '<span class="item-badge">◊ê◊ó◊®◊ï◊ü</span>' : '';
                const countBadge = `<span class="item-badge admin-count">${cycle.count} ◊®◊ô◊©◊ï◊û◊ô◊ù</span>`;
                const highlightClass = isHighlighted ? 'highlighted' : '';
                
                return `
                    <div class="dropdown-item ${highlightClass}" data-cycle-id="${cycle.id}" data-index="${index}">
                        <div class="item-text">${displayName}</div>
                        <div class="item-badges">
                            ${countBadge}
                            ${recentBadge}
                        </div>
                    </div>
                `;
            }
            
            selectAdminItem(cycle) {
                this.input.value = `${cycle.name} (${cycle.count} ◊®◊ô◊©◊ï◊û◊ô◊ù)`;
                this.hiddenInput.value = cycle.id;
                
                // Add to recent selections
                this.addToAdminRecent(cycle.id);
                
                this.close();
                
                // Trigger change event and auto-load registrations
                this.input.dispatchEvent(new Event('change', { bubbles: true }));
                
                // Auto-load registrations
                if (typeof fetchRegistrations === 'function') {
                    fetchRegistrations();
                }
            }
            
            addToAdminRecent(cycleId) {
                // Remove if already exists
                this.recentAdminSelections = this.recentAdminSelections.filter(id => id !== cycleId);
                // Add to beginning
                this.recentAdminSelections.unshift(cycleId);
                // Keep only last 5
                this.recentAdminSelections = this.recentAdminSelections.slice(0, 5);
                // Save to localStorage
                localStorage.setItem('recentAdminCycleSelections', JSON.stringify(this.recentAdminSelections));
            }
            
            open() {
                if (this.isOpen) return;
                
                this.isOpen = true;
                this.container.classList.add('open');
                
                // Load items if not already loaded
                if (this.adminCycles.length === 0) {
                    this.showLoading();
                    populateAdminCyclesDropdown();
                } else {
                    this.filterItems(this.input.value);
                }
            }
        }

        // Status Dropdown Class for table edit mode
        class StatusDropdown {
            constructor(dropdownElement) {
                this.dropdown = dropdownElement;
                this.input = dropdownElement.querySelector('.status-dropdown-input');
                this.list = dropdownElement.querySelector('.dropdown-list');
                this.arrow = dropdownElement.querySelector('.dropdown-arrow');
                this.isOpen = false;
                
                this.init();
            }
            
            init() {
                // Input click
                this.input.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.toggle();
                });
                
                // Arrow click
                this.arrow.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.toggle();
                });
                
                // Close on outside click
                document.addEventListener('click', (e) => {
                    if (!this.dropdown.contains(e.target)) {
                        this.close();
                    }
                });
            }
            
            toggle() {
                if (this.isOpen) {
                    this.close();
                } else {
                    this.open();
                }
            }
            
            open() {
                if (this.isOpen) return;
                
                this.isOpen = true;
                this.dropdown.classList.add('open');
                this.list.style.display = 'block';
            }
            
            close() {
                if (!this.isOpen) return;
                
                this.isOpen = false;
                this.dropdown.classList.remove('open');
                this.list.style.display = 'none';
            }
        }
        
        // Legacy filter function for backward compatibility
        function filterCycles(searchTerm) {
            if (modernDropdown) {
                modernDropdown.filterItems(searchTerm);
            }
        }

        // Enhanced populate admin cycles dropdown with rate limiting
        async function populateAdminCyclesDropdown() {
            if (!adminModernDropdown) return;
            
            try {
                // Use rate-limited and cached request for admin cycles
                const cacheKey = 'admin_cycles';
                const data = await window.clientRateLimiter.executeRequest(async () => {
                    const response = await window.requestCancellation.fetch('/api/admin-cycles', {}, 'fetch_admin_cycles');
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.message || `HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    return await response.json();
                }, cacheKey);
                
                const cyclesWithRegistrations = data.cycles || [];
                
                if (cyclesWithRegistrations.length > 0) {
                    console.log(`[Frontend] Loaded ${cyclesWithRegistrations.length} admin cycles (cached: ${data.fromCache})`);
                    adminModernDropdown.updateAdminCycles(cyclesWithRegistrations);
                } else {
                    console.log('[Frontend] No admin cycles found, trying fallback method');
                    await populateAdminCyclesDropdownFallback();
                }
                
            } catch (error) {
                console.error('[Frontend] Error with admin cycles endpoint, using fallback:', error);
                await populateAdminCyclesDropdownFallback();
            }
        }
        
        // Fallback method (original working logic)
        async function populateAdminCyclesDropdownFallback() {
            if (!adminModernDropdown) return;
            
            try {
                // Get all cycles first
                const cyclesResponse = await fetch('/api/cycles');
                if (!cyclesResponse.ok) {
                    throw new Error('Failed to fetch cycles');
                }
                
                const cyclesData = await cyclesResponse.json();
                const allCycles = cyclesData.cycles || [];
                
                // Filter cycles by pcfsystemfield549 != "◊§◊®◊ò◊ô"
                const validCycles = allCycles.filter(cycle => {
                    const fieldValue = cycle.pcfsystemfield549;
                    const trimmedValue = fieldValue ? fieldValue.toString().trim() : '';
                    return trimmedValue !== "◊§◊®◊ò◊ô";
                });
                
                console.log(`Filtered to ${validCycles.length} non-private cycles`);
                
                // Check each valid cycle for registrations (parallel for better performance)
                const registrationChecks = validCycles.map(async (cycle) => {
                    try {
                        const response = await fetch(`/api/registrations?cycleId=${cycle.id}`);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.registrations && data.registrations.length > 0) {
                                return {
                                    ...cycle,
                                    count: data.registrations.length
                                };
                            }
                        }
                    } catch (error) {
                        console.log(`Error checking cycle ${cycle.id}:`, error);
                    }
                    return null;
                });
                
                const results = await Promise.all(registrationChecks);
                const finalCycles = results.filter(cycle => cycle !== null);
                
                console.log(`Found ${finalCycles.length} cycles with registrations`);
                
                // Update the admin dropdown with cycles data
                adminModernDropdown.updateAdminCycles(finalCycles);
                
            } catch (error) {
                console.error('Error in fallback method:', error);
                // Set empty array if error occurs
                adminModernDropdown.updateAdminCycles([]);
            }
        }

        // Enhanced fetch registrations with rate limiting and error handling
        async function fetchRegistrations() {
            const cycleId = document.getElementById('selectedAdminCycleId').value;
            const resultsDiv = document.getElementById('registrationsResults');
            const titleEl = document.getElementById('registrationsTitle');
            const countEl = document.getElementById('registrationsCount');
            const listEl = document.getElementById('registrationsList');
            const fetchBtn = document.getElementById('fetchRegistrationsBtn');

            if (!cycleId) {
                // Only show alert if called manually (button still visible)
                if (fetchBtn.style.display !== 'none') {
                    alert('◊ê◊†◊ê ◊ë◊ó◊® ◊û◊ó◊ñ◊ï◊®');
                }
                return;
            }

            // Cancel any existing request for this cycle
            const requestKey = `registrations_${cycleId}`;
            window.requestCancellation.cancel(requestKey);

            // Show loading state
            fetchBtn.disabled = true;
            fetchBtn.textContent = 'üîÑ ◊ò◊ï◊¢◊ü...';
            listEl.innerHTML = '<div style="text-align: center; padding: 20px;">◊ò◊ï◊¢◊ü ◊®◊ô◊©◊ï◊û◊ô◊ù...</div>';
            resultsDiv.style.display = 'block';

            try {
                // Use debounced and rate-limited request
                const cacheKey = `registrations_${cycleId}`;
                const data = await window.clientRateLimiter.debounce(`fetch_${cycleId}`, async () => {
                    return await window.clientRateLimiter.executeRequest(async () => {
                        const response = await window.requestCancellation.fetch(`/api/registrations?cycleId=${cycleId}`, {}, requestKey);
                        
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            throw new Error(errorData.message || `HTTP ${response.status}: ${response.statusText}`);
                        }

                        return await response.json();
                    }, cacheKey);
                }, 500);

                // Update UI with fetched data
                const selectedCycle = allCycles.find(c => c.id == cycleId);
                const cycleName = selectedCycle ? selectedCycle.name : cycleId;
                
                titleEl.textContent = `◊®◊ô◊©◊ï◊û◊ô◊ù ◊ú◊û◊ó◊ñ◊ï◊®: ${cycleName}`;
                
                // Enhanced count display with cache info
                const cacheIndicator = data.fromCache || data.cached ? ' üìÅ' : '';
                countEl.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                        <span>üìà ◊°◊î"◊õ ◊®◊ô◊©◊ï◊û◊ô◊ù: ${data.count}${cacheIndicator}</span>
                        <small style="color: #666; font-size: 12px;">
                            ${data.timestamp ? `◊¢◊ï◊ì◊õ◊ü: ${new Date(data.timestamp).toLocaleString('he-IL')}` : ''}
                            ${data.cached ? ' (◊†◊©◊û◊® ◊ë◊û◊ò◊û◊ï◊ü)' : ''}
                        </small>
                    </div>
                `;

                // Store registrations for modal access
                currentRegistrations = data.registrations;

                if (data.registrations.length === 0) {
                    listEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">◊ê◊ô◊ü ◊®◊ô◊©◊ï◊û◊ô◊ù ◊ú◊û◊ó◊ñ◊ï◊® ◊ñ◊î</div>';
                } else {
                    listEl.innerHTML = createRegistrationsTable(data.registrations);
                }

                console.log(`[Frontend] Loaded ${data.registrations.length} registrations for cycle ${cycleName} (cached: ${data.cached || data.fromCache})`);

            } catch (error) {
                console.error('[Frontend] Error fetching registrations:', error);
                
                // Use enhanced error handling
                window.ErrorHandler.displayError(listEl, error, '◊ò◊¢◊ô◊†◊™ ◊®◊ô◊©◊ï◊û◊ô◊ù');
                
                // Add retry functionality
                listEl.addEventListener('retry', async () => {
                    console.log('[Frontend] Retrying registration fetch...');
                    await fetchRegistrations();
                }, { once: true });

            } finally {
                fetchBtn.disabled = false;
                fetchBtn.textContent = 'üîç ◊î◊¶◊í ◊®◊ô◊©◊ï◊û◊ô◊ù';
            }
        }

        // Create HTML table for registrations
        function createRegistrationsTable(registrations) {
            let html = `
                <div class="admin-table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>üë§ ◊©◊ù ◊î◊î◊ï◊®◊î</th>
                                <th>üìû ◊ò◊ú◊§◊ï◊ü</th>
                                <th>üë∂ ◊©◊ù ◊î◊ô◊ú◊ì/◊î</th>
                                <th>üìä ◊°◊ò◊ò◊ï◊°</th>
                                <th>‚öôÔ∏è ◊§◊¢◊ï◊ú◊ï◊™</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            registrations.forEach((registration, index) => {
                const statusText = getStatusText(registration.statusCode);
                const statusClass = getStatusClass(registration.statusCode);
                
                // Debug logging for status format
                if (index === 0) {
                    console.log(`[Status Debug] Sample registration status - Code: ${registration.statusCode}, Text: ${statusText}, Class: ${statusClass}`);
                }
                html += `
                    <tr id="row-${registration.registrationId}" data-account-id="${registration.accountId}" onclick="showRegistrationDetails('${registration.registrationId}')">
                        <td class="row-number">${index + 1}</td>
                        <td>
                            <span class="display-mode account-name">${registration.accountName}</span>
                            <input type="text" class="edit-mode edit-input account-name-input" value="${registration.accountName}" style="display: none;">
                        </td>
                        <td>
                            <div class="display-mode phone-cell-container">
                                <span class="phone-number">${registration.phoneNumber}</span>
                                <button class="whatsapp-btn" onclick="event.stopPropagation(); openWhatsAppModal('${registration.registrationId}', '${registration.phoneNumber}', '${registration.accountName}', '${registration.childName}')" title="◊©◊ú◊ó ◊î◊ï◊ì◊¢◊™ WhatsApp">
                                    <svg viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
                                    </svg>
                                </button>
                            </div>
                            <input type="text" class="edit-mode edit-input phone-number-input" value="${registration.phoneNumber}" style="display: none;">
                        </td>
                        <td>
                            <span class="display-mode child-name">${registration.childName}</span>
                            <input type="text" class="edit-mode edit-input child-name-input" value="${registration.childName}" style="display: none;">
                        </td>
                        <td class="status-cell">
                            <span class="display-mode status-badge ${statusClass}">${statusText}</span>
                            <div class="edit-mode modern-dropdown status-dropdown" id="statusDropdown-${registration.registrationId}" style="display: none;">
                                <input type="text" 
                                       class="status-dropdown-input" 
                                       id="statusInput-${registration.registrationId}"
                                       readonly
                                       value="${statusText}"
                                       data-value="${registration.statusCode}"
                                       onclick="event.stopPropagation();"
                                       autocomplete="off">
                                <div class="dropdown-arrow" onclick="event.stopPropagation();">‚ñº</div>
                                <div class="dropdown-list" id="statusDropdownList-${registration.registrationId}">
                                    ${generateStatusDropdownOptions(registration.statusCode)}
                                </div>
                            </div>
                        </td>
                        <td class="actions-cell">
                            <div style="display: flex; flex-direction: column; gap: 3px; align-items: center; padding: 2px;">
                                <button class="edit-btn table-btn" onclick="event.stopPropagation(); editRegistration('${registration.registrationId}')">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="margin-left: 4px;">
                                        <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                    </svg>
                                    ◊¢◊®◊ï◊ö
                                </button>
                                <button class="save-btn table-btn" onclick="event.stopPropagation(); saveRegistration('${registration.registrationId}')" style="display: none;">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="margin-left: 4px;">
                                        <path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/>
                                    </svg>
                                    ◊©◊û◊ï◊®
                                </button>
                                <button class="cancel-btn table-btn" onclick="event.stopPropagation(); cancelEdit('${registration.registrationId}')" style="display: none;">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="margin-left: 4px;">
                                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                                    </svg>
                                    ◊ë◊ò◊ú
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            return html;
        }

        // Get status text based on status code using dynamic options
        function getStatusText(statusCode) {
            const statusOption = statusOptions.find(option => option.value == statusCode);
            if (statusOption) {
                return statusOption.label;
            }
            
            // Fallback to hardcoded if not found
            const statusMap = {
                1: '‚úÖ ◊§◊¢◊ô◊ú',
                2: '‚è∏Ô∏è ◊ú◊ê ◊§◊¢◊ô◊ú',
                3: '‚ùå ◊ë◊ï◊ò◊ú',
                4: '‚è≥ ◊û◊û◊™◊ô◊ü',
                5: '‚úÖ ◊û◊ï◊©◊ú◊ù'
            };
            return statusMap[statusCode] || `(${statusCode})`;
        }

        // Get status CSS class based on status code - Updated with comprehensive mapping
        function getStatusClass(statusCode) {
            const statusClassMap = {
                4: 'status-new',        // ◊ó◊ì◊© (New)
                8: 'status-registered', // ◊†◊®◊©◊ù (Registered) 
                22: 'status-external',  // ◊†◊®◊©◊ù ◊ó◊ô◊¶◊ï◊†◊ô (External Registration)
                9: 'status-cancelled',  // ◊ë◊ô◊ò◊ú (Cancelled)
                23: 'status-waiting',   // ◊û◊ó◊õ◊î ◊ú◊©◊ô◊ë◊ï◊• (Waiting for Assignment)
                10: 'status-followup',  // ◊§◊ï◊ú◊ï◊ê◊§ (Follow-up)
                11: 'status-trial',     // ◊î◊ï◊ñ◊û◊†◊ï ◊ú◊©◊ô◊¢◊ï◊® ◊†◊°◊ô◊ï◊ü (Invited to Trial)
                18: 'status-completed', // ◊°◊ô◊ô◊ù (Completed)
                // Legacy mappings for backward compatibility
                1: 'status-registered',  // Changed to match registered status
                2: 'status-waiting',     // Changed to match waiting status  
                3: 'status-cancelled',
                5: 'status-completed'
            };
            
            const mappedClass = statusClassMap[statusCode];
            if (!mappedClass) {
                console.log(`[Status] Unknown status code: ${statusCode}, using fallback`);
            }
            
            return mappedClass || 'status-external'; // Default to external (orange) for unknown codes
        }
        
        // Reverse mapping: get status code from text
        function getStatusCodeFromText(statusText) {
            const statusOption = statusOptions.find(option => option.label === statusText);
            if (statusOption) {
                return statusOption.value;
            }
            
            // Fallback to hardcoded mapping if statusOptions not available
            const reverseStatusMap = {
                '‚úÖ ◊§◊¢◊ô◊ú': 1,
                '‚è∏Ô∏è ◊ú◊ê ◊§◊¢◊ô◊ú': 2,
                '‚ùå ◊ë◊ï◊ò◊ú': 3,
                '‚è≥ ◊û◊û◊™◊ô◊ü': 4,
                '‚úÖ ◊û◊ï◊©◊ú◊ù': 5
            };
            
            return reverseStatusMap[statusText] || null;
        }

        // Generate status dropdown options
        function generateStatusOptions(currentValue) {
            let options = '';
            statusOptions.forEach(option => {
                const selected = option.value == currentValue ? 'selected' : '';
                options += `<option value="${option.value}" ${selected}>${option.label}</option>`;
            });
            
            // If no options loaded, use fallback
            if (options === '') {
                const fallbackOptions = [
                    { value: 1, label: '‚úÖ ◊§◊¢◊ô◊ú' },
                    { value: 2, label: '‚è∏Ô∏è ◊ú◊ê ◊§◊¢◊ô◊ú' },
                    { value: 3, label: '‚ùå ◊ë◊ï◊ò◊ú' },
                    { value: 4, label: '‚è≥ ◊û◊û◊™◊ô◊ü' },
                    { value: 5, label: '‚úÖ ◊û◊ï◊©◊ú◊ù' }
                ];
                fallbackOptions.forEach(option => {
                    const selected = option.value == currentValue ? 'selected' : '';
                    options += `<option value="${option.value}" ${selected}>${option.label}</option>`;
                });
            }
            
            return options;
        }

        // Generate modern status dropdown options with icons and colors
        function generateStatusDropdownOptions(currentValue) {
            let options = '';
            const optionsToUse = statusOptions.length > 0 ? statusOptions : [
                { value: 4, label: '◊ó◊ì◊©', color: '#2196F3' },
                { value: 8, label: '◊†◊®◊©◊ù', color: '#4CAF50' },
                { value: 22, label: '◊†◊®◊©◊ù ◊ó◊ô◊¶◊ï◊†◊ô', color: '#4CAF50' },
                { value: 9, label: '◊ë◊ô◊ò◊ú', color: '#F44336' },
                { value: 23, label: '◊û◊ó◊õ◊î ◊ú◊©◊ô◊ë◊ï◊•', color: '#00BCD4' },
                { value: 10, label: '◊©◊ï◊ë◊•', color: '#8BC34A' },
                { value: 11, label: '◊î◊ï◊ñ◊û◊†◊ï ◊ú◊©◊ô◊¢◊ï◊® ◊†◊°◊ô◊ï◊ü', color: '#FF9800' },
                { value: 18, label: '◊°◊ô◊ô◊ù', color: '#9C27B0' }
            ];
            
            optionsToUse.forEach(option => {
                const color = option.color || '#666';
                const icon = getStatusIcon(option.value);
                const isSelected = option.value == currentValue;
                options += `
                    <div class="dropdown-item ${isSelected ? 'selected' : ''}" 
                         data-value="${option.value}" 
                         onclick="selectStatus(${option.value}, '${option.label}', event)">
                        <span class="status-icon" style="color: ${color}">${icon}</span>
                        <span class="status-label">${option.label}</span>
                    </div>
                `;
            });
            
            return options;
        }
        
        // Get status icon based on status code
        function getStatusIcon(statusCode) {
            const iconMap = {
                4: 'üÜï',   // ◊ó◊ì◊©
                8: '‚úÖ',   // ◊†◊®◊©◊ù
                22: '‚úÖ',  // ◊†◊®◊©◊ù ◊ó◊ô◊¶◊ï◊†◊ô
                9: '‚ùå',   // ◊ë◊ô◊ò◊ú
                23: '‚è≥',  // ◊û◊ó◊õ◊î ◊ú◊©◊ô◊ë◊ï◊•
                10: 'üìç',  // ◊©◊ï◊ë◊•
                11: 'üéØ',  // ◊î◊ï◊ñ◊û◊†◊ï ◊ú◊©◊ô◊¢◊ï◊® ◊†◊°◊ô◊ï◊ü
                18: 'üèÜ'   // ◊°◊ô◊ô◊ù
            };
            return iconMap[statusCode] || '‚ö™';
        }

        // Select status from dropdown and close it
        function selectStatus(value, label, event) {
            event.stopPropagation();
            
            // Find the dropdown that was clicked
            const dropdownItem = event.target.closest('.dropdown-item');
            const dropdownList = dropdownItem.closest('.dropdown-list');
            const dropdown = dropdownList.closest('.status-dropdown');
            const input = dropdown.querySelector('.status-dropdown-input');
            
            // Update the input with selected value
            input.value = label;
            input.setAttribute('data-value', value);
            
            // Update selection state
            dropdown.querySelectorAll('.dropdown-item').forEach(item => {
                item.classList.remove('selected');
            });
            dropdownItem.classList.add('selected');
            
            // Close dropdown
            if (dropdown.statusDropdown) {
                dropdown.statusDropdown.close();
            } else {
                dropdownList.style.display = 'none';
                dropdown.classList.remove('open');
            }
        }

        // Edit registration functions
        function editRegistration(registrationId) {
            console.log(`[Edit Mode] Starting edit for registration: ${registrationId}`);
            const row = document.getElementById(`row-${registrationId}`);
            
            if (!row) {
                console.error(`[Edit Mode] Row not found for registration: ${registrationId}`);
                return;
            }
            
            // Log current status before edit
            const currentStatusBadge = row.querySelector('.status-badge');
            const currentStatus = currentStatusBadge ? currentStatusBadge.textContent : 'Unknown';
            console.log(`[Edit Mode] Current status: ${currentStatus}`);
            
            // Hide display elements, show edit elements
            row.querySelectorAll('.display-mode').forEach(el => el.style.display = 'none');
            row.querySelectorAll('.edit-mode').forEach(el => el.style.display = 'block');
            
            // Initialize status dropdown
            const statusDropdownEl = row.querySelector('.status-dropdown');
            if (statusDropdownEl && !statusDropdownEl.statusDropdown) {
                statusDropdownEl.statusDropdown = new StatusDropdown(statusDropdownEl);
                console.log(`[Edit Mode] Initialized status dropdown for: ${registrationId}`);
            } else if (statusDropdownEl) {
                console.log(`[Edit Mode] Status dropdown already exists for: ${registrationId}`);
            } else {
                console.error(`[Edit Mode] Status dropdown element not found for: ${registrationId}`);
            }
            
            // Hide edit button, show save/cancel buttons
            row.querySelector('.edit-btn').style.display = 'none';
            row.querySelector('.save-btn').style.display = 'inline-block';
            row.querySelector('.cancel-btn').style.display = 'inline-block';
            
            console.log(`[Edit Mode] Successfully entered edit mode for: ${registrationId}`);
        }

        function cancelEdit(registrationId) {
            console.log(`[Cancel Edit] Exiting edit mode for registration: ${registrationId}`);
            const row = document.getElementById(`row-${registrationId}`);
            
            if (!row) {
                console.error(`[Cancel Edit] Row not found for registration: ${registrationId}`);
                return;
            }
            
            // Show display elements, hide edit elements
            row.querySelectorAll('.display-mode').forEach(el => el.style.display = 'block');
            row.querySelectorAll('.edit-mode').forEach(el => el.style.display = 'none');
            
            // Show edit button, hide save/cancel buttons
            row.querySelector('.edit-btn').style.display = 'inline-block';
            row.querySelector('.save-btn').style.display = 'none';
            row.querySelector('.cancel-btn').style.display = 'none';
            
            // Verify status badge is still present after exiting edit mode
            const statusBadge = row.querySelector('.status-badge');
            if (statusBadge) {
                console.log(`[Cancel Edit] Status badge verified: ${statusBadge.textContent} (${statusBadge.className})`);
            } else {
                console.error(`[Cancel Edit] Status badge missing after exiting edit mode for: ${registrationId}`);
            }
            
            console.log(`[Cancel Edit] Successfully exited edit mode for: ${registrationId}`);
        }

        async function saveRegistration(registrationId) {
            console.log(`[Save Registration] Starting save process for: ${registrationId}`);
            const row = document.getElementById(`row-${registrationId}`);
            
            if (!row) {
                console.error(`[Save Registration] Row not found for: ${registrationId}`);
                return;
            }
            
            const accountId = row.getAttribute('data-account-id');
            console.log(`[Save Registration] Account ID: ${accountId}`);
            
            // Get all input values
            const accountNameInput = row.querySelector('.account-name-input');
            const phoneNumberInput = row.querySelector('.phone-number-input');
            const childNameInput = row.querySelector('.child-name-input');
            const statusDropdownInput = row.querySelector('.status-dropdown-input');
            
            // Log input validation
            if (!statusDropdownInput) {
                console.error(`[Save Registration] Status dropdown input not found for: ${registrationId}`);
                return;
            }
            
            const newStatusCode = parseInt(statusDropdownInput.getAttribute('data-value'));
            const newStatusText = getStatusText(newStatusCode);
            console.log(`[Save Registration] New status selected: ${newStatusText} (code: ${newStatusCode})`);
            
            // Verify status badge exists before proceeding
            const currentStatusBadge = row.querySelector('.status-badge');
            if (!currentStatusBadge) {
                console.error(`[Save Registration] Status badge not found before save for: ${registrationId}`);
            } else {
                console.log(`[Save Registration] Current status badge: ${currentStatusBadge.textContent} (${currentStatusBadge.className})`);
            }
            
            const saveBtn = row.querySelector('.save-btn');
            const originalText = saveBtn.textContent;
            
            // Show loading state
            saveBtn.disabled = true;
            saveBtn.textContent = '‚è≥ ◊©◊ï◊û◊®...';
            
            try {
                // Check if customer fields (account name or phone) have changed
                const originalAccountName = row.querySelector('.account-name').textContent;
                const originalPhoneNumber = row.querySelector('.phone-number').textContent;
                
                let customerUpdateNeeded = false;
                let registrationUpdateNeeded = false;
                
                // Prepare customer update if needed
                if (accountNameInput.value !== originalAccountName || phoneNumberInput.value !== originalPhoneNumber) {
                    customerUpdateNeeded = true;
                }
                
                // Check if registration fields have changed
                const originalChildName = row.querySelector('.child-name').textContent;
                const statusBadgeElement = row.querySelector('.status-badge');
                const originalStatus = statusBadgeElement ? statusBadgeElement.textContent : '';
                const newStatus = getStatusText(parseInt(statusDropdownInput.getAttribute('data-value')));
                
                if (childNameInput.value !== originalChildName || newStatus !== originalStatus) {
                    registrationUpdateNeeded = true;
                }
                
                // Update customer information if needed
                if (customerUpdateNeeded) {
                    const customerResponse = await fetch('/api/update-customer', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            accountId: accountId,
                            accountName: accountNameInput.value,
                            phoneNumber: phoneNumberInput.value
                        })
                    });

                    const customerResult = await customerResponse.json();
                    if (!customerResponse.ok) {
                        throw new Error(customerResult.message || '◊©◊í◊ô◊ê◊î ◊ë◊¢◊ì◊õ◊ï◊ü ◊§◊®◊ò◊ô ◊î◊ú◊ß◊ï◊ó');
                    }
                }
                
                // Update registration information if needed
                if (registrationUpdateNeeded) {
                    console.log(`[API Call] Updating registration ${registrationId} with status: ${getStatusText(parseInt(statusDropdownInput.getAttribute('data-value')))}`);
                    
                    const registrationResponse = await fetch('/api/update-registration', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            registrationId: registrationId,
                            childName: childNameInput.value,
                            statusCode: parseInt(statusDropdownInput.getAttribute('data-value'))
                        })
                    });

                    let registrationResult;
                    try {
                        registrationResult = await registrationResponse.json();
                    } catch (parseError) {
                        console.error('[API Error] Failed to parse response:', parseError);
                        throw new Error('◊©◊í◊ô◊ê◊î ◊ë◊¢◊ô◊ë◊ï◊ì ◊™◊í◊ï◊ë◊™ ◊î◊©◊®◊™');
                    }
                    
                    if (!registrationResponse.ok) {
                        console.error('[API Error] Registration update failed:', {
                            status: registrationResponse.status,
                            statusText: registrationResponse.statusText,
                            error: registrationResult
                        });
                        throw new Error(registrationResult.message || `◊©◊í◊ô◊ê◊î ◊ë◊¢◊ì◊õ◊ï◊ü ◊î◊®◊ô◊©◊ï◊ù (${registrationResponse.status})`);
                    }
                    
                    console.log('[API Success] Registration updated successfully:', registrationResult);
                }

                // Update display text for all fields
                row.querySelector('.account-name').textContent = accountNameInput.value;
                row.querySelector('.phone-number').textContent = phoneNumberInput.value;
                row.querySelector('.child-name').textContent = childNameInput.value;
                
                // Update status badge with both text and proper CSS class
                const statusBadge = row.querySelector('.status-badge');
                const newStatusCode = parseInt(statusDropdownInput.getAttribute('data-value'));
                const newStatusText = getStatusText(newStatusCode);
                const newStatusClass = getStatusClass(newStatusCode);
                
                // Update status badge if it exists
                if (statusBadge) {
                    // Remove only existing status classes, preserve other classes including 'status-badge'
                    const currentClasses = statusBadge.className.split(' ');
                    const nonStatusClasses = currentClasses.filter(cls => !cls.startsWith('status-'));
                    
                    // Rebuild className with preserved classes plus new status class
                    statusBadge.className = [...nonStatusClasses, newStatusClass].join(' ');
                    statusBadge.textContent = newStatusText;
                    
                    console.log(`[Status Update] Updated status badge for ${registrationId}: ${newStatusText} (${newStatusClass})`);
                } else {
                    console.error('Status badge element not found for row:', registrationId);
                    // Try to recreate the status badge if missing
                    const statusCell = row.querySelector('.status-cell');
                    if (statusCell) {
                        const displayStatusBadge = statusCell.querySelector('.display-mode.status-badge');
                        if (!displayStatusBadge) {
                            console.log(`[DOM Recovery] Recreating missing status badge for row: ${registrationId}`);
                            const newStatusBadge = document.createElement('span');
                            newStatusBadge.className = `display-mode status-badge ${newStatusClass}`;
                            newStatusBadge.textContent = newStatusText;
                            statusCell.insertBefore(newStatusBadge, statusCell.firstChild);
                        }
                    }
                }
                
                // Update currentRegistrations array to sync modal data
                const registrationIndex = currentRegistrations.findIndex(r => r.registrationId === registrationId);
                if (registrationIndex !== -1) {
                    // Update the registration in the currentRegistrations array
                    currentRegistrations[registrationIndex] = {
                        ...currentRegistrations[registrationIndex],
                        accountName: accountNameInput.value,
                        phoneNumber: phoneNumberInput.value,
                        childName: childNameInput.value,
                        statusCode: parseInt(statusDropdownInput.getAttribute('data-value'))
                    };
                    console.log(`[Data Sync] Updated currentRegistrations for registration ${registrationId} with new status: ${getStatusText(currentRegistrations[registrationIndex].statusCode)}`);
                }
                
                // DOM Integrity Check: Verify all critical elements are still present
                const integrityCheck = {
                    row: !!document.getElementById(`row-${registrationId}`),
                    statusBadge: !!row.querySelector('.status-badge'),
                    statusCell: !!row.querySelector('.status-cell'),
                    editBtn: !!row.querySelector('.edit-btn'),
                    saveBtn: !!row.querySelector('.save-btn'),
                    cancelBtn: !!row.querySelector('.cancel-btn'),
                    displayElements: row.querySelectorAll('.display-mode').length > 0,
                    editElements: row.querySelectorAll('.edit-mode').length > 0
                };
                
                const integrityIssues = Object.entries(integrityCheck)
                    .filter(([key, value]) => !value)
                    .map(([key]) => key);
                
                if (integrityIssues.length > 0) {
                    console.error(`[DOM Integrity] Missing elements for row ${registrationId}:`, integrityIssues);
                    // Attempt to refresh the row if critical elements are missing
                    if (integrityIssues.includes('statusBadge') || integrityIssues.includes('editBtn')) {
                        console.warn(`[DOM Recovery] Critical elements missing, may need row refresh for ${registrationId}`);
                    }
                } else {
                    console.log(`[DOM Integrity] All elements validated for row ${registrationId}`);
                }
                
                // Exit edit mode
                cancelEdit(registrationId);
                
                // Final verification: Check if status badge is correct after all operations
                const finalStatusBadge = row.querySelector('.status-badge');
                if (finalStatusBadge) {
                    const finalStatusText = finalStatusBadge.textContent;
                    const expectedStatusText = getStatusText(newStatusCode);
                    
                    if (finalStatusText === expectedStatusText) {
                        console.log(`[Save Verification] Status update successful: ${finalStatusText}`);
                    } else {
                        console.error(`[Save Verification] Status mismatch! Expected: ${expectedStatusText}, Got: ${finalStatusText}`);
                    }
                    
                    // Verify CSS classes are correct
                    const hasStatusBadgeClass = finalStatusBadge.classList.contains('status-badge');
                    if (!hasStatusBadgeClass) {
                        console.error(`[Save Verification] Missing 'status-badge' class! Current classes: ${finalStatusBadge.className}`);
                    } else {
                        console.log(`[Save Verification] Status badge classes validated: ${finalStatusBadge.className}`);
                    }
                } else {
                    console.error(`[Save Verification] Status badge completely missing after save for: ${registrationId}`);
                }
                
                // Success - no alert notification needed, visual feedback is sufficient
                console.log('[Save Registration] Registration saved successfully:', {
                    customerUpdateNeeded,
                    registrationUpdateNeeded,
                    registrationId,
                    finalStatus: finalStatusBadge ? finalStatusBadge.textContent : 'N/A'
                });
                
            } catch (error) {
                console.error('Update error:', error);
                alert('‚ùå ◊©◊í◊ô◊ê◊î ◊ë◊¢◊ì◊õ◊ï◊ü: ' + error.message);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }

        // Form submission handler
        document.getElementById('registrationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.textContent;
            
            // Validate cycle selection
            const selectedCycleId = document.getElementById('selectedCycleId').value;
            if (!selectedCycleId) {
                const cycleError = document.getElementById('cycleError');
                cycleError.textContent = '◊ê◊†◊ê ◊ë◊ó◊® ◊û◊ó◊ñ◊ï◊® ◊™◊ï◊õ◊†◊ô◊™';
                cycleError.style.display = 'block';
                return;
            }
            
            // Disable submit button and show loading state
            submitBtn.disabled = true;
            submitBtn.textContent = '◊©◊ï◊ú◊ó...';
            
            const formData = new FormData(this);
            const registrationData = {
                parentName: formData.get('parentName'),
                phoneNumber: formData.get('phoneNumber'),
                email: formData.get('email'),
                childName: formData.get('childName'),
                childBirthDate: formData.get('childBirthDate'),
                programCycle: selectedCycleId // Use the hidden field value
            };
            
            try {
                const response = await fetch('/api/submit-registration', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(registrationData)
                });

                const result = await response.json();

                if (response.ok) {
                    // Create detailed success message
                    const details = [
                        `‚úÖ ${result.message}`,
                        '',
                        'üìã ◊§◊®◊ò◊ô ◊î◊®◊ô◊©◊ï◊ù:',
                        `üÜî ◊û◊ñ◊î◊î ◊ú◊ß◊ï◊ó: ${result.customerId}`,
                        `üìù ◊û◊ñ◊î◊î ◊®◊ô◊©◊ï◊ù: ${result.registrationId}`,
                        `üéØ ◊û◊ó◊ñ◊ï◊®: ${result.registrationData.programCycle}`,
                        `üë§ ◊©◊ù ◊î◊î◊ï◊®◊î: ${result.registrationData.parentName}`,
                        `üìß ◊ê◊ô◊û◊ô◊ô◊ú: ${result.registrationData.email}`,
                        `üìû ◊ò◊ú◊§◊ï◊ü: ${result.registrationData.phoneNumber}`,
                        `üë∂ ◊©◊ù ◊î◊ô◊ú◊ì/◊î: ${result.registrationData.childName}`,
                        `üéÇ ◊™◊ê◊®◊ô◊ö ◊ú◊ô◊ì◊î: ${result.registrationData.childBirthDate}`,
                        '',
                        result.customerExists ? 'üë• ◊†◊¢◊©◊î ◊©◊ô◊û◊ï◊© ◊ë◊ú◊ß◊ï◊ó ◊ß◊ô◊ô◊ù' : 'üÜï ◊†◊ï◊¶◊® ◊ú◊ß◊ï◊ó ◊ó◊ì◊©'
                    ];
                    
                    alert(details.join('\n'));
                    this.reset(); // Clear the form
                    
                    // Reload cycles dropdown
                    fetchActiveCycles();
                } else {
                    throw new Error(result.message || '◊©◊í◊ô◊ê◊î ◊ë◊©◊ú◊ô◊ó◊™ ◊î◊®◊ô◊©◊ï◊ù');
                }
                
            } catch (error) {
                console.error('Registration error:', error);
                alert('◊©◊í◊ô◊ê◊î ◊ë◊©◊ú◊ô◊ó◊™ ◊î◊®◊ô◊©◊ï◊ù: ' + error.message);
            } finally {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });

        // Fetch status options from Fireberry
        async function fetchStatusOptions() {
            try {
                const response = await fetch('/api/status-options');
                if (response.ok) {
                    const data = await response.json();
                    statusOptions = data.statusOptions || [];
                } else {
                    // Fallback to hardcoded options
                    statusOptions = [
                        { value: 4, label: '◊ó◊ì◊©', color: '#2196F3' },
                        { value: 8, label: '◊†◊®◊©◊ù', color: '#4CAF50' },
                        { value: 22, label: '◊†◊®◊©◊ù ◊ó◊ô◊¶◊ï◊†◊ô', color: '#4CAF50' },
                        { value: 9, label: '◊ë◊ô◊ò◊ú', color: '#F44336' },
                        { value: 23, label: '◊û◊ó◊õ◊î ◊ú◊©◊ô◊ë◊ï◊•', color: '#00BCD4' },
                        { value: 10, label: '◊§◊ï◊ú◊ï◊ê◊§', color: '#8BC34A' },
                        { value: 11, label: '◊î◊ï◊ñ◊û◊†◊ï ◊ú◊©◊ô◊¢◊ï◊® ◊†◊°◊ô◊ï◊ü', color: '#FF9800' },
                        { value: 18, label: '◊°◊ô◊ô◊ù', color: '#9C27B0' }
                    ];
                }
            } catch (error) {
                console.error('Error fetching status options:', error);
                // Fallback to hardcoded options
                statusOptions = [
                    { value: 4, label: '◊ó◊ì◊©', color: '#2196F3' },
                    { value: 8, label: '◊†◊®◊©◊ù', color: '#4CAF50' },
                    { value: 22, label: '◊†◊®◊©◊ù ◊ó◊ô◊¶◊ï◊†◊ô', color: '#4CAF50' },
                    { value: 9, label: '◊ë◊ô◊ò◊ú', color: '#F44336' },
                    { value: 23, label: '◊û◊ó◊õ◊î ◊ú◊©◊ô◊ë◊ï◊•', color: '#00BCD4' },
                    { value: 10, label: '◊§◊ï◊ú◊ï◊ê◊§', color: '#8BC34A' },
                    { value: 11, label: '◊î◊ï◊ñ◊û◊†◊ï ◊ú◊©◊ô◊¢◊ï◊® ◊†◊°◊ô◊ï◊ü', color: '#FF9800' },
                    { value: 18, label: '◊°◊ô◊ô◊ù', color: '#9C27B0' }
                ];
            }
        }

        // Initialize the form
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize modern dropdown
            modernDropdown = new ModernDropdown('cycleDropdown');
            
            // Initialize admin modern dropdown
            adminModernDropdown = new AdminModernDropdown('adminCycleDropdown');
            
            // Fetch cycles and status options
            fetchActiveCycles();
            fetchStatusOptions();

            // Add admin functionality
            const fetchRegistrationsBtn = document.getElementById('fetchRegistrationsBtn');
            fetchRegistrationsBtn.addEventListener('click', fetchRegistrations);
            
            // Add auto-load functionality to admin cycle dropdown
            const adminCycleSelect = document.getElementById('adminCycleSelect');
            const selectedAdminCycleId = document.getElementById('selectedAdminCycleId');
            
            adminCycleSelect.addEventListener('change', function() {
                if (selectedAdminCycleId.value) {
                    // Hide the manual fetch button since we're auto-loading
                    fetchRegistrationsBtn.style.display = 'none';
                    fetchRegistrations();
                } else {
                    // Show the fetch button when no cycle is selected
                    fetchRegistrationsBtn.style.display = 'inline-block';
                    // Clear results
                    const resultsDiv = document.getElementById('registrationsResults');
                    if (resultsDiv) {
                        resultsDiv.style.display = 'none';
                    }
                }
            });
        });
        
        // Modal functions for registration details
        function showRegistrationDetails(registrationId) {
            let registration = currentRegistrations.find(r => r.registrationId === registrationId);
            
            if (!registration) {
                console.error('Registration not found in currentRegistrations:', registrationId);
                return;
            }
            
            // Data integrity check: compare with table data to ensure sync
            const tableRow = document.getElementById(`row-${registrationId}`);
            if (tableRow) {
                const tableStatus = tableRow.querySelector('.status-badge')?.textContent;
                const modalStatus = getStatusText(registration.statusCode);
                
                if (tableStatus && tableStatus !== modalStatus) {
                    console.warn(`[Data Sync Warning] Modal data may be stale for registration ${registrationId}. Table shows: "${tableStatus}", Modal data shows: "${modalStatus}"`);
                    
                    // Update registration data from table if available
                    const tableAccountName = tableRow.querySelector('.account-name')?.textContent;
                    const tablePhoneNumber = tableRow.querySelector('.phone-number')?.textContent;
                    const tableChildName = tableRow.querySelector('.child-name')?.textContent;
                    
                    if (tableAccountName && tablePhoneNumber && tableChildName) {
                        registration = {
                            ...registration,
                            accountName: tableAccountName,
                            phoneNumber: tablePhoneNumber,
                            childName: tableChildName,
                            statusCode: getStatusCodeFromText(tableStatus)
                        };
                        
                        // Also update the currentRegistrations array to prevent future sync issues
                        const registrationIndex = currentRegistrations.findIndex(r => r.registrationId === registrationId);
                        if (registrationIndex !== -1) {
                            currentRegistrations[registrationIndex] = registration;
                        }
                        
                        console.log(`[Data Sync] Synced modal data with current table data for registration ${registrationId}`);
                    }
                }
            }
            
            // Format payment status
            const paymentStatusText = getPaymentStatusText(registration.paymentStatus);
            const paymentAmountText = registration.paymentAmount ? `‚Ç™${registration.paymentAmount}` : '◊ú◊ê ◊¶◊ï◊ô◊ü';
            
            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = `
                <div style="text-align: right; line-height: 1.6;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: #495057; display: flex; align-items: center; gap: 8px;">üë§ ◊§◊®◊ò◊ô ◊ú◊ß◊ï◊ó</h4>
                        <p style="margin: 5px 0;"><strong>◊©◊ù ◊î◊î◊ï◊®◊î:</strong> ${registration.accountName}</p>
                        <p style="margin: 5px 0;"><strong>◊ò◊ú◊§◊ï◊ü:</strong> ${registration.phoneNumber}</p>
                        <p style="margin: 5px 0;"><strong>◊©◊ù ◊î◊ô◊ú◊ì/◊î:</strong> ${registration.childName}</p>
                    </div>
                    
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: #1976d2; display: flex; align-items: center; gap: 8px;">üìä ◊§◊®◊ò◊ô ◊®◊ô◊©◊ï◊ù</h4>
                        <p style="margin: 5px 0;"><strong>◊°◊ò◊ò◊ï◊°:</strong> ${getStatusText(registration.statusCode)}</p>
                        <p style="margin: 5px 0;"><strong>◊û◊ñ◊î◊î ◊®◊ô◊©◊ï◊ù:</strong> ${registration.registrationId}</p>
                    </div>
                    
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px;">
                        <h4 style="margin: 0 0 10px 0; color: #388e3c; display: flex; align-items: center; gap: 8px;">üíé ◊§◊®◊ò◊ô ◊™◊©◊ú◊ï◊ù</h4>
                        <p style="margin: 5px 0;"><strong>◊°◊ò◊ò◊ï◊° ◊™◊©◊ú◊ï◊ù:</strong> <span style="padding: 3px 8px; border-radius: 4px; background: ${getPaymentStatusColor(registration.paymentStatus)}; color: white;">${paymentStatusText}</span></p>
                        <p style="margin: 5px 0;"><strong>◊°◊õ◊ï◊ù ◊©◊©◊ï◊ú◊ù:</strong> ${paymentAmountText}</p>
                    </div>
                </div>
            `;
            
            const modal = document.getElementById('registrationModal');
            modal.classList.add('show');
        }
        
        function closeRegistrationModal() {
            const modal = document.getElementById('registrationModal');
            modal.classList.remove('show');
        }

        // WhatsApp functionality
        let currentWhatsAppData = null;

        function openWhatsAppModal(registrationId, phoneNumber, accountName, childName) {
            console.log('[WhatsApp] Opening modal for:', { registrationId, phoneNumber, accountName, childName });

            // Store current data
            currentWhatsAppData = {
                registrationId,
                phoneNumber: phoneNumber.replace(/[^0-9]/g, ''), // Clean phone number
                accountName,
                childName
            };

            // Populate contact info
            const contactInfo = document.getElementById('whatsappContactInfo');
            contactInfo.innerHTML = `
                <h4>◊§◊®◊ò◊ô ◊î◊ú◊ß◊ï◊ó</h4>
                <p><strong>◊©◊ù ◊î◊î◊ï◊®◊î:</strong> ${accountName}</p>
                <p><strong>◊©◊ù ◊î◊ô◊ú◊ì/◊î:</strong> ${childName}</p>
                <p><strong>◊ò◊ú◊§◊ï◊ü:</strong> ${phoneNumber}</p>
            `;

            // Set default message
            const textarea = document.getElementById('whatsappMessage');
            textarea.value = `◊©◊ú◊ï◊ù ${accountName},\n\n◊ê◊†◊ô ◊§◊ï◊†◊î ◊ê◊ú◊ô◊ö ◊ë◊†◊ï◊í◊¢ ◊ú◊®◊ô◊©◊ï◊ù ◊©◊ú ${childName}.\n\n◊ë◊ë◊®◊õ◊î,\n◊¶◊ï◊ï◊™ ◊§◊ô◊ô◊®◊ë◊®◊ô`;

            // Show modal
            const modal = document.getElementById('whatsappModal');
            modal.classList.add('show');

            // Focus on textarea
            setTimeout(() => textarea.focus(), 300);
        }

        function closeWhatsAppModal() {
            const modal = document.getElementById('whatsappModal');
            modal.classList.remove('show');

            // Clear data and reset form
            currentWhatsAppData = null;
            document.getElementById('whatsappMessage').value = '';

            // Reset send button
            const sendBtn = document.getElementById('whatsappSendBtn');
            sendBtn.disabled = false;
            sendBtn.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                </svg>
                ◊©◊ú◊ó ◊î◊ï◊ì◊¢◊î
            `;
        }

        async function sendWhatsAppMessage() {
            if (!currentWhatsAppData) {
                console.error('[WhatsApp] No current data available');
                return;
            }

            const message = document.getElementById('whatsappMessage').value.trim();
            if (!message) {
                alert('◊ê◊†◊ê ◊î◊ñ◊ü ◊î◊ï◊ì◊¢◊î ◊ú◊©◊ú◊ô◊ó◊î');
                return;
            }

            const sendBtn = document.getElementById('whatsappSendBtn');
            const originalContent = sendBtn.innerHTML;

            try {
                // Show loading state
                sendBtn.disabled = true;
                sendBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="animation: spin 1s linear infinite;">
                        <path d="M12,4V2A10,10 0 0,0 2,12H4A8,8 0 0,1 12,4Z"/>
                    </svg>
                    ◊©◊ï◊ú◊ó...
                `;

                // Format phone number for Green API
                let formattedPhone = currentWhatsAppData.phoneNumber;

                // Remove leading zero if exists and add 972 for Israel
                if (formattedPhone.startsWith('0')) {
                    formattedPhone = '972' + formattedPhone.substring(1);
                } else if (!formattedPhone.startsWith('972')) {
                    formattedPhone = '972' + formattedPhone;
                }

                // Add @c.us suffix for WhatsApp format
                const whatsappPhone = formattedPhone + '@c.us';

                console.log('[WhatsApp] Sending message to:', whatsappPhone);

                // Green API credentials and endpoint
                const idInstance = '7103104732';
                const apiTokenInstance = '75e2c6fa07f0447792a45b3d92ae34702170655503044a0396';
                const apiUrl = `https://7103.api.greenapi.com/waInstance${idInstance}/sendMessage/${apiTokenInstance}`;

                // Prepare request body
                const requestBody = {
                    chatId: whatsappPhone,
                    message: message
                };

                console.log('[WhatsApp] Request body:', requestBody);

                // Send request
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const result = await response.json();
                console.log('[WhatsApp] API Response:', result);

                if (response.ok && result.idMessage) {
                    // Success
                    console.log('[WhatsApp] Message sent successfully:', result.idMessage);

                    // Show success message
                    sendBtn.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/>
                        </svg>
                        ◊†◊©◊ú◊ó ◊ë◊î◊¶◊ú◊ó◊î!
                    `;

                    // Close modal after a short delay
                    setTimeout(() => {
                        closeWhatsAppModal();

                        // Show success notification
                        const notification = document.createElement('div');
                        notification.style.cssText = `
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
                            color: white;
                            padding: 12px 20px;
                            border-radius: 8px;
                            z-index: 10000;
                            font-weight: 500;
                            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
                            display: flex;
                            align-items: center;
                            gap: 8px;
                        `;
                        notification.innerHTML = `
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/>
                            </svg>
                            ◊î◊ï◊ì◊¢◊™ WhatsApp ◊†◊©◊ú◊ó◊î ◊ë◊î◊¶◊ú◊ó◊î ◊ú-${currentWhatsAppData.accountName}
                        `;

                        document.body.appendChild(notification);

                        // Remove notification after 4 seconds
                        setTimeout(() => {
                            document.body.removeChild(notification);
                        }, 4000);

                    }, 1500);

                } else {
                    // Error response
                    throw new Error(result.error || result.message || '◊©◊í◊ô◊ê◊î ◊ú◊ê ◊ô◊ì◊ï◊¢◊î ◊ë◊©◊ú◊ô◊ó◊™ ◊î◊î◊ï◊ì◊¢◊î');
                }

            } catch (error) {
                console.error('[WhatsApp] Error sending message:', error);

                // Reset button
                sendBtn.disabled = false;
                sendBtn.innerHTML = originalContent;

                // Show error message
                let errorMessage = '◊©◊í◊ô◊ê◊î ◊ë◊©◊ú◊ô◊ó◊™ ◊î◊î◊ï◊ì◊¢◊î. ◊ê◊†◊ê ◊†◊°◊î ◊©◊ï◊ë.';

                if (error.message) {
                    if (error.message.includes('network')) {
                        errorMessage = '◊©◊í◊ô◊ê◊™ ◊®◊©◊™. ◊ê◊†◊ê ◊ë◊ì◊ï◊ß ◊ê◊™ ◊î◊ó◊ô◊ë◊ï◊® ◊ú◊ê◊ô◊†◊ò◊®◊†◊ò ◊ï◊†◊°◊î ◊©◊ï◊ë.';
                    } else if (error.message.includes('unauthorized')) {
                        errorMessage = '◊©◊í◊ô◊ê◊™ ◊î◊®◊©◊ê◊î. ◊ê◊†◊ê ◊§◊†◊î ◊ú◊û◊†◊î◊ú ◊î◊û◊¢◊®◊õ◊™.';
                    } else if (error.message.includes('phone')) {
                        errorMessage = '◊û◊°◊§◊® ◊î◊ò◊ú◊§◊ï◊ü ◊ê◊ô◊†◊ï ◊™◊ß◊ô◊ü ◊ê◊ï ◊ú◊ê ◊®◊©◊ï◊ù ◊ë-WhatsApp.';
                    } else {
                        errorMessage = `◊©◊í◊ô◊ê◊î: ${error.message}`;
                    }
                }

                alert(errorMessage);
            }
        }
        
        function getPaymentStatusText(paymentStatus) {
            // You can customize these based on your actual payment status values
            switch(paymentStatus) {
                case 1: return '◊©◊ï◊ú◊ù';
                case 2: return '◊ú◊ê ◊©◊ï◊ú◊ù';
                case 3: return '◊™◊©◊ú◊ï◊ù ◊ó◊ú◊ß◊ô';
                case 4: return '◊î◊ó◊ñ◊®';
                default: return paymentStatus || '◊ú◊ê ◊¶◊ï◊ô◊ü';
            }
        }
        
        function getPaymentStatusColor(paymentStatus) {
            switch(paymentStatus) {
                case 1: return '#4CAF50'; // Green for paid
                case 2: return '#f44336'; // Red for unpaid
                case 3: return '#FF9800'; // Orange for partial
                case 4: return '#9C27B0'; // Purple for refund
                default: return '#95a5a6'; // Gray for unknown
            }
        }
        
        // Close modal when clicking outside
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('registrationModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeRegistrationModal();
                    }
                });
            }

            // WhatsApp modal outside click
            const whatsappModal = document.getElementById('whatsappModal');
            if (whatsappModal) {
                whatsappModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeWhatsAppModal();
                    }
                });
            }
        });
    </script>
</body>
</html>